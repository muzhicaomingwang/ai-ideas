<!--pages/index/index.wxml-->
<view class="index-page">
  <view class="page-header">
    <view class="header-title-row">
      <view class="header-title">生成团建方案（MVP）</view>
      <view class="version-badge">V0.0.1</view>
    </view>
    <view class="header-subtitle">仅支持小红书链接/口令导入生成 Markdown</view>
  </view>

  <view class="content">
    <view class="card">
      <view class="card-title">小红书导入</view>
      <view class="hint">粘贴分享链接/口令后，系统会解析并返回笔记内容，自动填入下方文档框。</view>

      <view class="xhs-input-row">
        <textarea
          class="xhs-input"
          placeholder="粘贴小红书链接或分享口令..."
          value="{{xhsLink}}"
          bindinput="handleXhsLinkInput"
          maxlength="20000"
          auto-height
        />
        <view class="xhs-paste" bindtap="handlePasteXhsLink">粘贴</view>
      </view>

      <view class="xhs-actions">
        <button class="btn-secondary" bindtap="handleResetXhsImport" disabled="{{xhsImportStatus === 'parsing'}}">清空</button>
        <button class="btn-primary" bindtap="handleStartXhsParse" disabled="{{!xhsLink || xhsImportStatus === 'parsing'}}">开始解析</button>
      </view>

      <block wx:if="{{xhsImportStatus === 'parsing'}}">
        <view class="xhs-parsing">
          <view class="xhs-parsing-title">正在解析...</view>
          <view class="xhs-progress">
            <view class="xhs-progress-bar">
              <view class="xhs-progress-fill" style="width: {{xhsParseProgress}}%;"></view>
            </view>
            <view class="xhs-progress-text">{{xhsParseProgress}}%</view>
          </view>
          <view class="xhs-parsing-sub">首次解析可能较慢，请稍等</view>
        </view>
      </block>

      <block wx:if="{{xhsImportStatus === 'error'}}">
        <view class="xhs-error">
          <view class="xhs-error-title">解析失败</view>
          <view class="xhs-error-msg">{{xhsParseError}}</view>
          <view class="xhs-error-hint" wx:if="{{xhsParseErrorCode === 'PARSE_FAILED'}}">URL 抓取正文可能受限，建议粘贴“分享口令全文/正文文本”再试。</view>
          <view class="xhs-error-hint" wx:else>建议粘贴“分享口令全文/正文文本”，或用模板补全分天信息。</view>
          <view class="xhs-action-row" wx:if="{{xhsParseErrorCode === 'PARSE_FAILED'}}">
            <view class="xhs-action-btn secondary" bindtap="handleCopyXhsPasteGuide">复制粘贴指南</view>
            <view class="xhs-action-btn" bindtap="handleFillXhsItineraryTemplate">用补全模板填入</view>
          </view>
        </view>
      </block>
    </view>

    <view class="card" wx:if="{{formData.markdownContent}}">
      <view class="card-title">生成的 Markdown</view>
      <textarea class="markdown-preview" value="{{formData.markdownContent}}" disabled="true" auto-height />
    </view>

    <view class="helper">
      <text>点击「生成方案」后会异步生成（约 1-2 分钟），可在「我的方案」查看结果。</text>
    </view>
  </view>

  <view class="bottom-bar">
    <button class="btn-primary" bindtap="handleGenerate" disabled="{{isSubmitting || !formData.markdownContent}}">
      生成方案
    </button>
  </view>
</view>
