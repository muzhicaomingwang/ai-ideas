<!--
  è¡Œç¨‹ç¼–è¾‘å™¨é¡µé¢ - è¡¨å•åŒ–å¯è§†åŒ–ç¼–è¾‘
  æ”¯æŒï¼šæ·»åŠ /åˆ é™¤å¤©æ•°ã€æ´»åŠ¨ç®¡ç†ã€æ—¶é—´å†²çªæ£€æµ‹ã€æ’¤é”€/é‡åš
-->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="header">
    <view class="header-left">
      <view class="back-btn" bindtap="goBack">
        <text class="icon-back">â€¹</text>
        <text>è¿”å›</text>
      </view>
    </view>
    <view class="header-title">{{planTitle || 'ç¼–è¾‘è¡Œç¨‹'}}</view>
    <view class="header-right">
      <view class="undo-redo">
        <view class="icon-btn {{historyIndex <= 0 ? 'disabled' : ''}}" bindtap="undo">
          <text class="icon">â†¶</text>
        </view>
        <view class="icon-btn {{historyIndex >= historyStack.length - 1 ? 'disabled' : ''}}" bindtap="redo">
          <text class="icon">â†·</text>
        </view>
      </view>
    </view>
  </view>

  <!-- éªŒè¯é”™è¯¯æç¤º -->
  <view class="validation-errors" wx:if="{{validationErrors.length > 0}}">
    <view class="error-item" wx:for="{{validationErrors}}" wx:key="index">
      <text class="error-icon">âš </text>
      <text class="error-text">{{item}}</text>
    </view>
  </view>

  <!-- è¡Œç¨‹å†…å®¹ -->
  <scroll-view class="content" scroll-y="true" enhanced="true" show-scrollbar="false">
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{itinerary.days.length === 0}}">
      <view class="empty-icon">ğŸ“…</view>
      <view class="empty-text">æš‚æ— è¡Œç¨‹å®‰æ’</view>
      <view class="empty-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€å¤©è¡Œç¨‹</view>
    </view>

    <!-- å¤©æ•°åˆ—è¡¨ -->
    <view class="days-list" wx:else>
      <view class="day-card" wx:for="{{itinerary.days}}" wx:key="day" wx:for-index="dayIndex">
        <!-- å¤©æ•°å¤´éƒ¨ -->
        <view class="day-header">
          <view class="day-info">
            <view class="day-number">ç¬¬{{item.day}}å¤©</view>
            <picker mode="date" value="{{item.date}}" bindchange="onDateChange" data-day-index="{{dayIndex}}">
              <view class="day-date">
                <text>{{item.date || 'é€‰æ‹©æ—¥æœŸ'}}</text>
                <text class="icon-calendar">ğŸ“…</text>
              </view>
            </picker>
          </view>
          <view class="day-actions">
            <view class="action-btn danger" bindtap="deleteDay" data-day-index="{{dayIndex}}" wx:if="{{itinerary.days.length > 1}}">
              <text class="icon">ğŸ—‘</text>
            </view>
          </view>
        </view>

        <!-- æ´»åŠ¨åˆ—è¡¨ -->
        <view class="activities-list">
          <!-- ç©ºæ´»åŠ¨æç¤º -->
          <view class="empty-activities" wx:if="{{item.items.length === 0}}">
            <text class="hint">æš‚æ— æ´»åŠ¨å®‰æ’ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ </text>
          </view>

          <!-- æ´»åŠ¨é¡¹ -->
          <view class="activity-item {{dragInfo.isDragging && dragInfo.dayIndex === dayIndex && dragInfo.itemIndex === itemIndex ? 'dragging' : ''}}"
                wx:for="{{item.items}}" wx:for-item="activity" wx:for-index="itemIndex" wx:key="id">
            <view class="activity-content" bindtap="editActivity" data-day-index="{{dayIndex}}" data-item-index="{{itemIndex}}">
              <!-- æ—¶é—´ -->
              <view class="activity-time">
                <text class="time-text">{{activity.time_start || '--:--'}}</text>
                <text class="time-separator">-</text>
                <text class="time-text">{{activity.time_end || '--:--'}}</text>
              </view>
              <!-- è¯¦æƒ… -->
              <view class="activity-details">
                <view class="activity-name">{{activity.activity || 'æœªå‘½åæ´»åŠ¨'}}</view>
                <view class="activity-location" wx:if="{{activity.location}}">
                  <text class="icon-location">ğŸ“</text>
                  <text>{{activity.location}}</text>
                </view>
                <view class="activity-note" wx:if="{{activity.note}}">
                  <text class="note-text">{{activity.note}}</text>
                </view>
              </view>
            </view>

            <!-- æ´»åŠ¨æ“ä½œæŒ‰é’® -->
            <view class="activity-actions">
              <view class="action-btn small" bindtap="moveActivity" data-day-index="{{dayIndex}}" data-item-index="{{itemIndex}}" data-direction="up" wx:if="{{itemIndex > 0}}">
                <text class="icon">â†‘</text>
              </view>
              <view class="action-btn small" bindtap="moveActivity" data-day-index="{{dayIndex}}" data-item-index="{{itemIndex}}" data-direction="down" wx:if="{{itemIndex < item.items.length - 1}}">
                <text class="icon">â†“</text>
              </view>
              <view class="action-btn small" bindtap="copyActivity" data-day-index="{{dayIndex}}" data-item-index="{{itemIndex}}">
                <text class="icon">ğŸ“‹</text>
              </view>
              <view class="action-btn small danger" bindtap="deleteActivity" data-day-index="{{dayIndex}}" data-item-index="{{itemIndex}}">
                <text class="icon">âœ•</text>
              </view>
            </view>
          </view>

          <!-- æ·»åŠ æ´»åŠ¨æŒ‰é’® -->
          <view class="add-activity-btn" bindtap="addActivity" data-day-index="{{dayIndex}}">
            <text class="icon">+</text>
            <text>æ·»åŠ æ´»åŠ¨</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ·»åŠ å¤©æ•°æŒ‰é’® -->
    <view class="add-day-section">
      <view class="add-day-btn" bindtap="addDay">
        <text class="icon">+</text>
        <text>æ·»åŠ æ–°çš„ä¸€å¤©</text>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="footer">
    <view class="footer-left">
      <view class="status-indicator {{hasChanges ? 'unsaved' : 'saved'}}">
        <text class="status-dot"></text>
        <text class="status-text">{{hasChanges ? 'æœ‰æœªä¿å­˜çš„æ›´æ”¹' : 'å·²ä¿å­˜'}}</text>
      </view>
    </view>
    <view class="footer-right">
      <button class="btn btn-secondary" bindtap="preview">é¢„è§ˆ</button>
      <button class="btn btn-primary {{isSaving ? 'loading' : ''}}" bindtap="save" disabled="{{isSaving || !hasChanges}}">
        <text wx:if="{{isSaving}}">ä¿å­˜ä¸­...</text>
        <text wx:else>ä¿å­˜</text>
      </button>
    </view>
  </view>

  <!-- æ´»åŠ¨ç¼–è¾‘å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showActivityEditor}}" bindtap="closeActivityEditor"></view>
  <view class="activity-editor-modal {{showActivityEditor ? 'show' : ''}}">
    <view class="modal-header">
      <text class="modal-title">{{editingItemIndex === -1 ? 'æ·»åŠ æ´»åŠ¨' : 'ç¼–è¾‘æ´»åŠ¨'}}</text>
      <view class="modal-close" bindtap="closeActivityEditor">âœ•</view>
    </view>

    <view class="modal-content">
      <!-- æ—¶é—´é€‰æ‹© -->
      <view class="form-group">
        <view class="form-label">æ—¶é—´</view>
        <view class="time-range-picker">
          <picker mode="time" value="{{editingActivity.time_start}}" bindchange="onActivityFieldChange" data-field="time_start">
            <view class="time-picker-btn">
              <text>{{editingActivity.time_start || 'å¼€å§‹æ—¶é—´'}}</text>
            </view>
          </picker>
          <text class="time-separator">è‡³</text>
          <picker mode="time" value="{{editingActivity.time_end}}" bindchange="onActivityFieldChange" data-field="time_end">
            <view class="time-picker-btn">
              <text>{{editingActivity.time_end || 'ç»“æŸæ—¶é—´'}}</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- æ´»åŠ¨åç§° -->
      <view class="form-group">
        <view class="form-label required">æ´»åŠ¨åç§°</view>
        <input class="form-input"
               placeholder="è¯·è¾“å…¥æ´»åŠ¨åç§°"
               value="{{editingActivity.activity}}"
               bindinput="onActivityFieldChange"
               data-field="activity"
               maxlength="50" />
      </view>

      <!-- åœ°ç‚¹ -->
      <view class="form-group">
        <view class="form-label">åœ°ç‚¹</view>
        <input class="form-input"
               placeholder="è¯·è¾“å…¥æ´»åŠ¨åœ°ç‚¹ï¼ˆé€‰å¡«ï¼‰"
               value="{{editingActivity.location}}"
               bindinput="onActivityFieldChange"
               data-field="location"
               maxlength="100" />
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-group">
        <view class="form-label">å¤‡æ³¨</view>
        <textarea class="form-textarea"
                  placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
                  value="{{editingActivity.note}}"
                  bindinput="onActivityFieldChange"
                  data-field="note"
                  maxlength="200"
                  auto-height="true" />
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="closeActivityEditor">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="saveActivityEdit">ç¡®å®š</button>
    </view>
  </view>
</view>
