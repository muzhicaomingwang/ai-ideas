<!--pages/myplans/myplans.wxml-->
<view class="myplans-page">
  <!-- Tab ç­›é€‰æ  -->
  <view class="tabs-container">
    <view
      wx:for="{{tabs}}"
      wx:key="key"
      class="tab-item {{currentTab === item.key ? 'active' : ''}}"
      bindtap="handleTabChange"
      data-key="{{item.key}}"
    >
      {{item.name}}
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-icon">â³</view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && plans.length === 0}}">
    <view class="empty-icon">ğŸ“­</view>
    <view class="empty-text">è¿˜æ²¡æœ‰æ–¹æ¡ˆ</view>
    <view class="empty-hint">å¿«å»ç”Ÿæˆä¸€ä¸ªå›¢å»ºæ–¹æ¡ˆå§</view>
    <button class="btn-create" bindtap="handleGoCreate">
      å»ç”Ÿæˆæ–¹æ¡ˆ
    </button>
  </view>

  <!-- æ–¹æ¡ˆåˆ—è¡¨ -->
  <view class="plans-list" wx:if="{{!loading && plans.length > 0}}">
    <view
      wx:for="{{plans}}"
      wx:key="plan_id"
      class="plan-card"
      bindtouchstart="handleTouchStart"
      bindtouchmove="handleTouchMove"
      bindtouchend="handleTouchEnd"
      data-index="{{index}}"
    >
      <!-- æ“ä½œæŒ‰é’®ï¼ˆå·¦æ»‘æ˜¾ç¤ºï¼Œåœ¨card-contentä¸‹æ–¹ï¼‰ -->
      <view class="action-btns">
        <!-- å½’æ¡£æŒ‰é’®ï¼ˆä»…å·²ç”Ÿæˆçš„æ–¹æ¡ˆæ˜¾ç¤ºï¼‰ -->
        <view
          wx:if="{{item.status !== 'generating' && item.status !== 'failed'}}"
          class="archive-btn"
          catchtap="handleArchive"
          data-plan-id="{{item.plan_id}}"
          data-index="{{index}}">
          å½’æ¡£
        </view>
        <!-- åˆ é™¤æŒ‰é’® -->
        <view class="delete-btn" catchtap="handleDelete" data-plan-id="{{item.plan_id}}" data-index="{{index}}">
          åˆ é™¤
        </view>
      </view>
      <!-- å¡ç‰‡å†…å®¹ï¼ˆæ»‘åŠ¨æ—¶ç§»åŠ¨ï¼‰ -->
      <view
        class="card-content {{item.status === 'generating' ? 'generating-card' : (item.status === 'failed' ? 'failed-card' : '')}}"
        style="transform: translateX({{item.translateX || 0}}rpx)"
        bindtap="handleViewPlan"
        data-plan-id="{{item.plan_id}}"
        data-index="{{index}}">
        <!-- å¤´éƒ¨ -->
        <view class="card-header">
          <view class="plan-title">
            <text class="plan-name">{{item.plan_name}}</text>
          </view>
          <view class="status-badge status-{{item.status}}">
            <text wx:if="{{item.status === 'generating'}}" class="generating-icon">â³</text>
            {{item.status_label}}
          </view>
        </view>

        <!-- ç”Ÿæˆä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºè¿›åº¦æç¤º -->
        <view class="generating-info" wx:if="{{item.status === 'generating'}}">
          <view class="generating-progress">
            <view class="progress-dots">
              <view class="progress-dot"></view>
              <view class="progress-dot"></view>
              <view class="progress-dot"></view>
            </view>
            <text class="generating-text">AIæ­£åœ¨ä¸ºæ‚¨è§„åˆ’æ–¹æ¡ˆ...</text>
          </view>
          <view
            class="refresh-btn {{item.refreshing ? 'refreshing' : ''}}"
            catchtap="handleRefreshPlan"
            data-plan-id="{{item.plan_id}}"
            data-index="{{index}}"
          >
            <text class="refresh-icon {{item.refreshing ? 'rotating' : ''}}">ğŸ”„</text>
            <text class="refresh-text">{{item.refreshing ? 'åˆ·æ–°ä¸­' : 'åˆ·æ–°çŠ¶æ€'}}</text>
          </view>
        </view>

        <!-- å¤±è´¥çŠ¶æ€ï¼šæ˜¾ç¤ºé‡è¯•æç¤º -->
        <view class="failed-info" wx:if="{{item.status === 'failed'}}">
          <view class="failed-message">
            <text class="failed-icon">âŒ</text>
            <text class="failed-text">æ–¹æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</text>
          </view>
          <view
            class="retry-btn"
            catchtap="handleRetryGenerate"
            data-plan-id="{{item.plan_id}}"
            data-index="{{index}}"
          >
            <text class="retry-icon">ğŸ”„</text>
            <text class="retry-text">é‡æ–°ç”Ÿæˆ</text>
          </view>
        </view>

        <!-- å‡ºå‘åŸå¸‚ â†’ ç›®çš„åœ° -->
        <view class="plan-location" wx:if="{{(item.departure_city || item.destination) && item.status !== 'generating' && item.status !== 'failed'}}">
          <text class="location-icon">ğŸ“</text>
          <text class="location-text" wx:if="{{item.departure_city && item.destination}}">{{item.departure_city}} â†’ {{item.destination}}</text>
          <text class="location-text" wx:elif="{{item.destination}}">{{item.destination}}</text>
          <text class="location-text" wx:else>{{item.departure_city}}</text>
          <text class="location-date" wx:if="{{item.start_date}}">{{item.start_date}} ~ {{item.end_date}}</text>
        </view>

        <!-- ç»Ÿè®¡ä¿¡æ¯ï¼ˆéç”Ÿæˆä¸­/å¤±è´¥çŠ¶æ€æ˜¾ç¤ºï¼‰ -->
        <view class="plan-stats" wx:if="{{item.status !== 'generating' && item.status !== 'failed'}}">
          <view class="stat-item">
            <text class="stat-icon">ğŸ’°</text>
            <text class="stat-text">Â¥{{item.budget_total}}</text>
          </view>
          <view class="stat-divider">|</view>
          <view class="stat-item">
            <text class="stat-icon">ğŸ‘¥</text>
            <text class="stat-text">{{item.people_count}}äºº</text>
          </view>
          <view class="stat-divider">|</view>
          <view class="stat-item">
            <text class="stat-icon">ğŸ“…</text>
            <text class="stat-text">{{item.duration}}</text>
          </view>
        </view>

        <!-- ç”Ÿæˆä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ -->
        <view class="plan-stats" wx:if="{{item.status === 'generating'}}">
          <view class="stat-item">
            <text class="stat-icon">ğŸ‘¥</text>
            <text class="stat-text">{{item.people_count || '-'}}äºº</text>
          </view>
          <view class="stat-divider">|</view>
          <view class="stat-item">
            <text class="stat-icon">ğŸ“</text>
            <text class="stat-text" wx:if="{{item.departure_city && item.destination}}">{{item.departure_city}} â†’ {{item.destination}}</text>
            <text class="stat-text" wx:elif="{{item.destination}}">{{item.destination}}</text>
            <text class="stat-text" wx:elif="{{item.departure_city}}">ä»{{item.departure_city}}å‡ºå‘</text>
            <text class="stat-text" wx:else>å¾…ç”Ÿæˆ</text>
          </view>
        </view>

        <!-- æ—¥æœŸ -->
        <view class="plan-date" wx:if="{{item.start_date && item.end_date && item.status !== 'generating'}}">
          {{item.start_date}} è‡³ {{item.end_date}}
        </view>

        <!-- æ—¶é—´æˆ³ -->
        <view class="plan-time">
          {{item.relative_time}}
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore}}">
      <view class="load-more-text" wx:if="{{!loadingMore}}">
        ä¸Šæ‹‰åŠ è½½æ›´å¤š
      </view>
      <view class="load-more-loading" wx:if="{{loadingMore}}">
        <view class="loading-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && plans.length > 0}}">
      æ²¡æœ‰æ›´å¤šäº†
    </view>
  </view>
</view>
