<!--pages/detail/detail.wxml-->
<view class="detail-page">
  <!-- æ–¹æ¡ˆæ¦‚è§ˆ -->
  <view class="plan-overview card">
    <view class="overview-header">
      <view class="plan-title">
        <text class="plan-name">{{plan.plan_name}}</text>
        <view class="recommended-badge" wx:if="{{plan.recommended}}">â­ æ¨è</view>
      </view>
      <view class="status-badge status-{{plan.status}}">
        {{plan.status_label}}
      </view>
    </view>

    <view class="overview-stats">
      <view class="stat-item">
        <text class="stat-value">{{plan.duration}}</text>
        <text class="stat-label">å¤©æ•°</text>
      </view>
    </view>

    <!-- äº®ç‚¹ -->
    <view class="highlights" wx:if="{{plan.highlight}}">
      <view class="highlights-title">ğŸ’¡ äº®ç‚¹</view>
      <view class="highlights-content">{{plan.highlight}}</view>
    </view>
  </view>

  <!-- è¡Œç¨‹å®‰æ’ -->
  <view class="section-panel">
    <view class="panel-header" bindtap="toggleSection" data-section="itinerary">
      <view class="panel-title-row">
        <text class="panel-title">è¡Œç¨‹å®‰æ’</text>
        <view class="itinerary-change-pill" catchtap="goItineraryChange">è¡Œç¨‹å˜æ›´</view>
        <view
          class="itinerary-save-pill {{itineraryEdit.saving ? 'disabled' : ''}}"
          wx:if="{{itineraryEdit.dirty}}"
          catchtap="handleSaveItineraryEdits"
        >
          {{itineraryEdit.saving ? 'ä¿å­˜ä¸­' : 'ä¿å­˜æ”¹åŠ¨'}}
        </view>
        <text class="panel-version">v{{plan.itinerary_version || 1}}</text>
      </view>
      <text class="toggle-icon">{{sections.itinerary ? 'â–¼' : 'â–¶'}}</text>
    </view>
    <view class="panel-content {{sections.itinerary ? 'expanded' : ''}}">
      <view class="itinerary-day-list">
        <view
          wx:for="{{itineraryUi.days}}"
          wx:key="day"
          class="itinerary-day"
        >
          <view class="day-header">
            <text class="day-title">Day {{item.day}}</text>
            <text class="day-date" wx:if="{{item.dateLabel}}">ï¼ˆ{{item.dateLabel}}ï¼‰</text>
          </view>

          <scroll-view class="cards-scroll" scroll-x enhanced show-scrollbar="{{false}}">
            <view class="cards-row">
              <view
                wx:for="{{item.cards}}"
                wx:for-item="item2"
                wx:key="_key"
                class="it-card it-card-{{item2.type}}"
                catchtap="openCardActionSheet"
                data-day="{{item.day}}"
                data-index="{{item2.itemIndex}}"
              >
                <view class="it-card-badges">
                  <text class="it-badge it-badge-type">{{item2.typeLabel}}</text>
                </view>
                <view class="it-card-time" wx:if="{{item2.time}}">{{item2.time}}</view>
                <view class="it-card-title">{{item2.title}}</view>
                <view class="it-card-sub" wx:if="{{item2.subtitle}}">{{item2.subtitle}}</view>
                <view class="it-card-note" wx:if="{{item2.noteLine}}">{{item2.noteLine}}</view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <button
      class="btn-confirm"
      bindtap="handleSubmitReview"
      wx:if="{{plan.status === 'draft'}}"
    >
      é€šæ™’æ­¤æ–¹æ¡ˆ
    </button>
    <!-- é€šæ™’ä¸­çŠ¶æ€ï¼šæ˜¾ç¤º3ä¸ªæ“ä½œæŒ‰é’® -->
    <view class="reviewing-actions" wx:if="{{plan.status === 'reviewing'}}">
      <button class="btn-action btn-confirm" bindtap="handleConfirmPlan">æ–¹æ¡ˆç¡®è®¤</button>
      <button class="btn-action btn-cancel" bindtap="handleCancelPlan">æ–¹æ¡ˆå–æ¶ˆ</button>
      <button class="btn-action btn-archive" bindtap="handleArchivePlan">æ–¹æ¡ˆå½’æ¡£</button>
    </view>
    <button
      class="btn-confirmed"
      disabled
      wx:if="{{plan.status === 'confirmed'}}"
    >
      âœ“ å·²ç¡®è®¤
    </button>
  </view>
</view>

<!-- é€šæ™’ï¼šç¡®è®¤å‡ºå‘æ—¥æœŸ -->
<view class="dialog-mask" wx:if="{{confirmDateDialog.visible}}" catchtap="handleConfirmDateCancel">
  <view class="dialog" catchtap="noop">
    <view class="dialog-title">ç¡®è®¤å‡ºå‘æ—¥æœŸ</view>
    <view class="dialog-sub">é€šæ™’å‰è¯·ç¡®è®¤å…·ä½“å‡ºå‘æ—¥æœŸï¼ˆç¡®è®¤åå°†æ˜¾ç¤ºæ¯å¤©æ—¥æœŸï¼‰ã€‚</view>
    <picker mode="date" value="{{confirmDateDialog.startDate}}" bindchange="handleConfirmDateChange">
      <view class="dialog-picker">{{confirmDateDialog.startDate}}</view>
    </picker>
    <view class="dialog-actions">
      <view class="dialog-btn dialog-btn-cancel" bindtap="handleConfirmDateCancel">å–æ¶ˆ</view>
      <view class="dialog-btn dialog-btn-ok" bindtap="handleConfirmDateOk">ç¡®è®¤</view>
    </view>
  </view>
</view>

<!-- å¡ç‰‡ç¼–è¾‘å™¨ -->
<view class="dialog-mask" wx:if="{{cardEditor.visible}}" catchtap="closeCardEditor">
  <view class="dialog dialog-wide" catchtap="noop">
    <view class="dialog-title">
      <text wx:if="{{cardEditor.mode === 'edit'}}">ä¿®æ”¹å¡ç‰‡</text>
      <text wx:elif="{{cardEditor.mode === 'insert_left'}}">å·¦ä¾§æ–°å¢å¡ç‰‡</text>
      <text wx:else>å³ä¾§æ–°å¢å¡ç‰‡</text>
    </view>

    <view class="type-tabs">
      <view class="type-tab {{cardEditor.type === 'transport' ? 'active' : ''}}" catchtap="handleCardEditorTypeSelect" data-type="transport">äº¤é€š</view>
      <view class="type-tab {{cardEditor.type === 'nearby' ? 'active' : ''}}" catchtap="handleCardEditorTypeSelect" data-type="nearby">å‘¨è¾¹æ¸¸</view>
      <view class="type-tab {{cardEditor.type === 'accommodation' ? 'active' : ''}}" catchtap="handleCardEditorTypeSelect" data-type="accommodation">ä½å®¿</view>
    </view>

    <view class="dialog-field">
      <view class="field-label">å†…å®¹</view>
      <input class="field-input" value="{{cardEditor.activity}}" bindinput="handleCardEditorInput" data-field="activity" placeholder="ä¾‹å¦‚ï¼šå¤–æ»© / å…¥ä½é…’åº— / å¤§å·´å‰å¾€..." />
    </view>

    <view class="dialog-field">
      <view class="field-label">åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰</view>
      <input class="field-input" value="{{cardEditor.location}}" bindinput="handleCardEditorInput" data-field="location" placeholder="ä¾‹å¦‚ï¼šé»„æµ¦åŒº / æŸé…’åº— / é›†åˆç‚¹..." />
    </view>

    <view class="dialog-field">
      <view class="field-label">æ—¶é—´ï¼ˆå¯é€‰ï¼‰</view>
      <view class="time-row">
        <input class="time-input" value="{{cardEditor.time_start}}" bindinput="handleCardEditorInput" data-field="time_start" placeholder="09:00" />
        <view class="time-sep">-</view>
        <input class="time-input" value="{{cardEditor.time_end}}" bindinput="handleCardEditorInput" data-field="time_end" placeholder="10:30" />
      </view>
      <view class="field-hint">å¯åªå¡«å¤§è‡´æ—¶é—´èŒƒå›´ï¼Œä¸å¡«ä¹Ÿå¯ä»¥</view>
    </view>

    <view class="dialog-field">
      <view class="field-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</view>
      <input class="field-input" value="{{cardEditor.note}}" bindinput="handleCardEditorInput" data-field="note" placeholder="è¡¥å……è¯´æ˜..." />
    </view>

    <view class="dialog-actions">
      <view class="dialog-btn dialog-btn-cancel" bindtap="closeCardEditor">å–æ¶ˆ</view>
      <view class="dialog-btn dialog-btn-ok" bindtap="handleCardEditorConfirm">ç¡®è®¤</view>
    </view>
  </view>
</view>
