<!--pages/detail/detail.wxml-->
<view class="detail-page">
  <!-- æ–¹æ¡ˆæ¦‚è§ˆ -->
  <view class="plan-overview card">
    <view class="overview-header">
      <view class="plan-title">
        <text class="plan-name">{{plan.plan_name}}</text>
        <view class="recommended-badge" wx:if="{{plan.recommended}}">â­ æ¨è</view>
      </view>
      <view class="status-badge status-{{plan.status}}">
        {{plan.status_label}}
      </view>
    </view>

    <view class="overview-stats">
      <view class="stat-item">
        <text class="stat-value">Â¥{{plan.budget_total}}</text>
        <text class="stat-label">æ€»é¢„ç®—</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{plan.budget_per_person}}</text>
        <text class="stat-label">äººå‡</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{plan.duration}}</text>
        <text class="stat-label">å¤©æ•°</text>
      </view>
    </view>

    <!-- äº®ç‚¹ -->
    <view class="highlights" wx:if="{{plan.highlight}}">
      <view class="highlights-title">ğŸ’¡ äº®ç‚¹</view>
      <view class="highlights-content">{{plan.highlight}}</view>
    </view>
  </view>

  <!-- è¡Œç¨‹å®‰æ’ -->
  <view class="section-panel">
    <view class="panel-header" bindtap="toggleSection" data-section="itinerary">
      <view class="panel-title-row">
        <text class="panel-title">è¡Œç¨‹å®‰æ’</text>
        <view class="itinerary-change-pill" catchtap="goItineraryChange">è¡Œç¨‹å˜æ›´</view>
        <text class="panel-version">v{{plan.itinerary_version || 1}}</text>
      </view>
      <text class="toggle-icon">{{sections.itinerary ? 'â–¼' : 'â–¶'}}</text>
    </view>
    <view class="panel-content {{sections.itinerary ? 'expanded' : ''}}">
      <view class="itinerary-timeline">
        <view
          wx:for="{{plan.itinerary.days}}"
          wx:key="day"
          class="timeline-day"
        >
          <view class="day-header">
            <text class="day-title">Day {{item.day}}</text>
            <text class="day-date" wx:if="{{item.date}}">ï¼ˆ{{item.date}}ï¼‰</text>
          </view>
          <view class="timeline-items">
            <view
              wx:for="{{item.items}}"
              wx:for-item="timeItem"
              wx:key="time_start"
              class="timeline-item"
            >
              <view class="time-dot"></view>
              <view class="time-line" wx:if="{{index < item.items.length - 1}}"></view>
              <view class="time-content">
                <view class="time-range">{{timeItem.time_start}} - {{timeItem.time_end}}</view>
                <view class="activity-name">{{timeItem.activity}}</view>
                <view class="activity-location" wx:if="{{timeItem.location}}">
                  ğŸ“ {{timeItem.location}}
                </view>
                <view class="activity-note" wx:if="{{timeItem.note}}">
                  {{timeItem.note}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åœ°å›¾è·¯çº¿ -->
  <view class="section-panel">
    <view class="panel-header" bindtap="toggleSection" data-section="map">
      <text class="panel-title">åœ°å›¾è·¯çº¿</text>
      <text class="toggle-icon">{{sections.map ? 'â–¼' : 'â–¶'}}</text>
    </view>
    <view class="panel-content {{sections.map ? 'expanded' : ''}}">
      <view class="map-panel">
        <scroll-view
          class="day-tabs"
          scroll-x="true"
          wx:if="{{plan.itinerary && plan.itinerary.days && plan.itinerary.days.length > 1}}"
        >
          <view class="day-tabs-inner">
            <view
              wx:for="{{plan.itinerary.days}}"
              wx:key="day"
              class="day-tab {{selectedDay === item.day ? 'active' : ''}}"
              bindtap="handleSelectDay"
              data-day="{{item.day}}"
            >
              Day {{item.day}}
            </view>
          </view>
        </scroll-view>

        <view class="map-loading" wx:if="{{routeLoading}}">
          <text>è·¯çº¿åŠ è½½ä¸­...</text>
        </view>
        <view class="map-empty" wx:elif="{{!routeLoading && (!route || !route.markers || route.markers.length === 0)}}">
          <text>æš‚æ— å¯å®šä½çš„è·¯çº¿ç‚¹ä½</text>
        </view>

        <map
          wx:else
          class="route-map"
          longitude="{{route.markers[0].longitude}}"
          latitude="{{route.markers[0].latitude}}"
          scale="12"
          markers="{{route.markers}}"
          polyline="{{route.polyline}}"
          include-points="{{route.include_points}}"
          show-location="true"
        />
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions">
    <button
      class="btn-confirm"
      bindtap="handleSubmitReview"
      wx:if="{{plan.status === 'draft'}}"
    >
      é€šæ™’æ­¤æ–¹æ¡ˆ
    </button>
    <!-- é€šæ™’ä¸­çŠ¶æ€ï¼šæ˜¾ç¤º3ä¸ªæ“ä½œæŒ‰é’® -->
    <view class="reviewing-actions" wx:if="{{plan.status === 'reviewing'}}">
      <button class="btn-action btn-confirm" bindtap="handleConfirmPlan">æ–¹æ¡ˆç¡®è®¤</button>
      <button class="btn-action btn-cancel" bindtap="handleCancelPlan">æ–¹æ¡ˆå–æ¶ˆ</button>
      <button class="btn-action btn-archive" bindtap="handleArchivePlan">æ–¹æ¡ˆå½’æ¡£</button>
    </view>
    <button
      class="btn-confirmed"
      disabled
      wx:if="{{plan.status === 'confirmed'}}"
    >
      âœ“ å·²ç¡®è®¤
    </button>
  </view>
</view>
