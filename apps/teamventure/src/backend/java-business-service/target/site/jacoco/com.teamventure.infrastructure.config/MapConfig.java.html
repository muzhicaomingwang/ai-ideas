<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MapConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamVenture Business Service</a> &gt; <a href="index.source.html" class="el_package">com.teamventure.infrastructure.config</a> &gt; <span class="el_source">MapConfig.java</span></div><h1>MapConfig.java</h1><pre class="source lang-java linenums">package com.teamventure.infrastructure.config;

import io.github.resilience4j.circuitbreaker.CircuitBreaker;
import io.github.resilience4j.circuitbreaker.CircuitBreakerConfig;
import io.github.resilience4j.circuitbreaker.CircuitBreakerRegistry;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.io.IOException;
import java.net.ConnectException;
import java.net.SocketTimeoutException;
import java.time.Duration;

/**
 * 地图服务配置类
 *
 * 配置熔断器、重试等resilience组件
 *
 * @author TeamVenture
 * @since 2026-01-14
 */
@Configuration
<span class="fc" id="L23">public class MapConfig {</span>

    /**
     * 配置高德地图API的熔断器
     *
     * 熔断策略：
     * - 失败率达到50%时开启熔断
     * - 熔断后等待30秒再尝试半开状态
     * - 滑动窗口10次请求
     * - 至少5次调用后才开始计算失败率
     *
     * @return CircuitBreaker实例
     */
    @Bean
    public CircuitBreaker mapCircuitBreaker() {
<span class="fc" id="L38">        CircuitBreakerConfig config = CircuitBreakerConfig.custom()</span>
<span class="fc" id="L39">            .failureRateThreshold(50)  // 失败率阈值50%</span>
<span class="fc" id="L40">            .waitDurationInOpenState(Duration.ofSeconds(30))  // 熔断后等待30秒</span>
<span class="fc" id="L41">            .slidingWindowSize(10)  // 滑动窗口大小10次请求</span>
<span class="fc" id="L42">            .minimumNumberOfCalls(5)  // 至少5次调用才计算失败率</span>
<span class="fc" id="L43">            .permittedNumberOfCallsInHalfOpenState(3)  // 半开状态允许3次调用</span>
<span class="fc" id="L44">            .automaticTransitionFromOpenToHalfOpenEnabled(true)  // 自动从开启转半开</span>
<span class="fc" id="L45">            .recordException(MapConfig::shouldRecord)</span>
<span class="fc" id="L46">            .ignoreExceptions(IllegalArgumentException.class)  // 参数错误不计入失败率</span>
<span class="fc" id="L47">            .build();</span>

<span class="fc" id="L49">        CircuitBreaker circuitBreaker = CircuitBreaker.of(&quot;amap-static-api&quot;, config);</span>

        // 注册事件监听（用于监控和告警）
<span class="fc" id="L52">        circuitBreaker.getEventPublisher()</span>
<span class="fc" id="L53">            .onStateTransition(event -&gt; {</span>
                // 熔断状态变化时记录日志
<span class="fc" id="L55">                org.slf4j.LoggerFactory.getLogger(MapConfig.class)</span>
<span class="fc" id="L56">                    .warn(&quot;CircuitBreaker state changed: {} -&gt; {}&quot;,</span>
<span class="fc" id="L57">                        event.getStateTransition().getFromState(),</span>
<span class="fc" id="L58">                        event.getStateTransition().getToState()</span>
                    );
<span class="fc" id="L60">            })</span>
<span class="fc" id="L61">            .onFailureRateExceeded(event -&gt; {</span>
                // 失败率超过阈值时告警
<span class="fc" id="L63">                org.slf4j.LoggerFactory.getLogger(MapConfig.class)</span>
<span class="fc" id="L64">                    .error(&quot;CircuitBreaker failure rate exceeded: {}%&quot;,</span>
<span class="fc" id="L65">                        event.getFailureRate()</span>
                    );
<span class="fc" id="L67">            });</span>

<span class="fc" id="L69">        return circuitBreaker;</span>
    }

    private static boolean shouldRecord(Throwable t) {
<span class="fc" id="L73">        Throwable cur = t;</span>
<span class="pc bpc" id="L74" title="2 of 4 branches missed.">        for (int i = 0; i &lt; 8 &amp;&amp; cur != null; i++) {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            if (cur instanceof SocketTimeoutException) return true;</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (cur instanceof ConnectException) return true;</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (cur instanceof IOException) return true;</span>
<span class="fc" id="L78">            cur = cur.getCause();</span>
        }
<span class="nc" id="L80">        return false;</span>
    }

    /**
     * 配置熔断器注册表（用于管理多个熔断器）
     *
     * @return CircuitBreakerRegistry
     */
    @Bean
    public CircuitBreakerRegistry circuitBreakerRegistry() {
<span class="fc" id="L90">        return CircuitBreakerRegistry.of(</span>
<span class="fc" id="L91">            CircuitBreakerConfig.ofDefaults()</span>
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>