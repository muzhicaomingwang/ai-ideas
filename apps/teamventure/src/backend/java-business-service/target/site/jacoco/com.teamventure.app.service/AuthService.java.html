<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamVenture Business Service</a> &gt; <a href="index.source.html" class="el_package">com.teamventure.app.service</a> &gt; <span class="el_source">AuthService.java</span></div><h1>AuthService.java</h1><pre class="source lang-java linenums">package com.teamventure.app.service;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.teamventure.adapter.web.auth.AuthController.LoginResponse;
import com.teamventure.app.support.BizException;
import com.teamventure.app.support.IdGenerator;
import com.teamventure.app.support.JwtSupport;
import com.teamventure.infrastructure.persistence.mapper.UserMapper;
import com.teamventure.infrastructure.persistence.po.UserPO;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.time.Duration;
import java.util.HexFormat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

@Service
public class AuthService {
<span class="nc" id="L22">    private static final Logger log = LoggerFactory.getLogger(AuthService.class);</span>
    private static final long EXPIRES_SECONDS = 604800L; // 7 days
    private static final long REFRESH_THRESHOLD_SECONDS = 43200L; // Refresh when &lt; 12 hours remaining

    private final UserMapper userMapper;
    private final StringRedisTemplate redis;
    private final JwtSupport jwt;
    private final OssService ossService;

    public AuthService(
            UserMapper userMapper,
            StringRedisTemplate redis,
            @Value(&quot;${teamventure.jwt.secret:change-me-change-me-change-me-change-me}&quot;) String jwtSecret,
            OssService ossService
<span class="nc" id="L36">    ) {</span>
<span class="nc" id="L37">        this.userMapper = userMapper;</span>
<span class="nc" id="L38">        this.redis = redis;</span>
<span class="nc" id="L39">        this.jwt = new JwtSupport(jwtSecret);</span>
<span class="nc" id="L40">        this.ossService = ossService;</span>
<span class="nc" id="L41">    }</span>

    public LoginResponse loginWithWeChat(String code, String nickname, String avatarUrl) {
<span class="nc" id="L44">        String openid = pseudoOpenId(code);</span>

<span class="nc" id="L46">        UserPO user = userMapper.selectOne(new QueryWrapper&lt;UserPO&gt;().eq(&quot;wechat_openid&quot;, openid));</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (user == null) {</span>
            // 创建新用户
<span class="nc" id="L49">            user = new UserPO();</span>
<span class="nc" id="L50">            user.setUserId(IdGenerator.newId(&quot;user&quot;));</span>
<span class="nc" id="L51">            user.setWechatOpenid(openid);</span>
            // 使用传入的nickname，如果为空则使用默认值
<span class="nc bnc" id="L53" title="All 2 branches missed.">            user.setNickname(hasText(nickname) ? nickname.trim() : &quot;微信用户&quot;);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            user.setAvatarUrl(hasText(avatarUrl) ? avatarUrl : &quot;&quot;);</span>
<span class="nc" id="L55">            user.setRole(&quot;HR&quot;);</span>
<span class="nc" id="L56">            user.setStatus(&quot;ACTIVE&quot;);</span>
<span class="nc" id="L57">            userMapper.insert(user);</span>
        } else {
            // 更新现有用户信息（如果提供了新的nickname或avatarUrl）
<span class="nc" id="L60">            boolean needUpdate = false;</span>

<span class="nc bnc" id="L62" title="All 4 branches missed.">            if (hasText(nickname) &amp;&amp; !nickname.trim().equals(user.getNickname())) {</span>
<span class="nc" id="L63">                user.setNickname(nickname.trim());</span>
<span class="nc" id="L64">                needUpdate = true;</span>
            }

<span class="nc bnc" id="L67" title="All 4 branches missed.">            if (hasText(avatarUrl) &amp;&amp; !avatarUrl.equals(user.getAvatarUrl())) {</span>
<span class="nc" id="L68">                user.setAvatarUrl(avatarUrl);</span>
<span class="nc" id="L69">                needUpdate = true;</span>
            }

<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (needUpdate) {</span>
<span class="nc" id="L73">                userMapper.updateById(user);</span>
            }
        }

<span class="nc" id="L77">        String token = jwt.issueToken(user.getUserId(), EXPIRES_SECONDS);</span>
        try {
<span class="nc" id="L79">            redis.opsForValue().set(&quot;session:&quot; + token, user.getUserId(), Duration.ofSeconds(EXPIRES_SECONDS));</span>
<span class="nc" id="L80">        } catch (Exception e) {</span>
            // Redis 不可用时仍允许登录，后续请求可回退到 JWT 解析
<span class="nc" id="L82">            log.warn(&quot;redis unavailable when setting session token, fallback to stateless jwt: userId={}&quot;, user.getUserId(), e);</span>
<span class="nc" id="L83">        }</span>

        // 构建包含完整userInfo的响应
<span class="nc" id="L86">        String avatar = ossService.resolveAvatarUrl(user.getUserId(), user.getAvatarUrl());</span>
<span class="nc" id="L87">        LoginResponse.UserInfo userInfo = new LoginResponse.UserInfo(</span>
<span class="nc" id="L88">            user.getUserId(),</span>
<span class="nc" id="L89">            user.getNickname(),</span>
            avatar,
<span class="nc" id="L91">            user.getPhone(),</span>
<span class="nc" id="L92">            user.getCompany(),</span>
<span class="nc" id="L93">            user.getRole()</span>
        );

<span class="nc" id="L96">        return new LoginResponse(token, userInfo);</span>
    }

    // 辅助方法：检查字符串是否有内容
    private boolean hasText(String str) {
<span class="nc bnc" id="L101" title="All 4 branches missed.">        return str != null &amp;&amp; !str.trim().isEmpty();</span>
    }

    public String getUserIdFromAuthorization(String authorization) {
<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (authorization == null || !authorization.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L106">            throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;missing bearer token&quot;);</span>
        }
<span class="nc" id="L108">        String token = authorization.substring(&quot;Bearer &quot;.length()).trim();</span>
<span class="nc" id="L109">        String userId = null;</span>
        try {
<span class="nc" id="L111">            userId = redis.opsForValue().get(&quot;session:&quot; + token);</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
            // 本地联调常见：Redis 未启动/密码不一致/网络不可达，避免直接 500
<span class="nc" id="L114">            log.warn(&quot;redis unavailable when reading session token, fallback to stateless jwt&quot;, e);</span>
<span class="nc" id="L115">        }</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (userId == null) {</span>
            // fallback: parse jwt (stateless); still requires that token is valid
            try {
<span class="nc" id="L119">                userId = jwt.parseUserId(token);</span>
<span class="nc" id="L120">            } catch (Exception e) {</span>
<span class="nc" id="L121">                throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;invalid token&quot;);</span>
<span class="nc" id="L122">            }</span>
        }
<span class="nc" id="L124">        return userId;</span>
    }

    /**
     * Refresh token if it's close to expiration.
     * Returns new token and user info, or null if token doesn't need refresh.
     */
    public LoginResponse refreshTokenIfNeeded(String authorization) {
<span class="nc bnc" id="L132" title="All 4 branches missed.">        if (authorization == null || !authorization.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L133">            throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;missing bearer token&quot;);</span>
        }
<span class="nc" id="L135">        String token = authorization.substring(&quot;Bearer &quot;.length()).trim();</span>

        // Validate and extract userId
        String userId;
        try {
<span class="nc" id="L140">            userId = jwt.parseUserId(token);</span>
<span class="nc" id="L141">        } catch (Exception e) {</span>
<span class="nc" id="L142">            throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;invalid token&quot;);</span>
<span class="nc" id="L143">        }</span>

        // Check if token needs refresh
        boolean needsRefresh;
        try {
<span class="nc" id="L148">            needsRefresh = jwt.willExpireSoon(token, REFRESH_THRESHOLD_SECONDS);</span>
<span class="nc" id="L149">        } catch (Exception e) {</span>
<span class="nc" id="L150">            throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;invalid token&quot;);</span>
<span class="nc" id="L151">        }</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!needsRefresh) {</span>
<span class="nc" id="L154">            return null; // Token is still fresh, no refresh needed</span>
        }

        // Issue new token
<span class="nc" id="L158">        String newToken = jwt.issueToken(userId, EXPIRES_SECONDS);</span>

        // Update Redis session
        try {
            // Delete old session
<span class="nc" id="L163">            redis.delete(&quot;session:&quot; + token);</span>
            // Create new session
<span class="nc" id="L165">            redis.opsForValue().set(&quot;session:&quot; + newToken, userId, Duration.ofSeconds(EXPIRES_SECONDS));</span>
<span class="nc" id="L166">        } catch (Exception e) {</span>
<span class="nc" id="L167">            log.warn(&quot;redis unavailable when refreshing token, fallback to stateless jwt: userId={}&quot;, userId, e);</span>
<span class="nc" id="L168">        }</span>

        // Load user info
<span class="nc" id="L171">        UserPO user = userMapper.selectOne(new QueryWrapper&lt;UserPO&gt;().eq(&quot;user_id&quot;, userId));</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L173">            throw new BizException(&quot;UNAUTHENTICATED&quot;, &quot;user not found&quot;);</span>
        }

<span class="nc" id="L176">        String avatar = ossService.resolveAvatarUrl(user.getUserId(), user.getAvatarUrl());</span>
<span class="nc" id="L177">        LoginResponse.UserInfo userInfo = new LoginResponse.UserInfo(</span>
<span class="nc" id="L178">            user.getUserId(),</span>
<span class="nc" id="L179">            user.getNickname(),</span>
            avatar,
<span class="nc" id="L181">            user.getPhone(),</span>
<span class="nc" id="L182">            user.getCompany(),</span>
<span class="nc" id="L183">            user.getRole()</span>
        );

<span class="nc" id="L186">        log.info(&quot;Token refreshed for user: {}&quot;, userId);</span>
<span class="nc" id="L187">        return new LoginResponse(newToken, userInfo);</span>
    }

    private static String pseudoOpenId(String code) {
        // 开发模式：使用固定的 openid，确保同一设备登录到同一账号
        // TODO: 生产环境需调用微信 API (jscode2session) 获取真实 openid
        // 暂时使用固定 openid 方便测试，所有用户登录到同一账号
<span class="nc" id="L194">        return &quot;openid_dev_fixed_user&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>