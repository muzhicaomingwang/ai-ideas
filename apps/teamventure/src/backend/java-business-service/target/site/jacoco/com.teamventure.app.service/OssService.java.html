<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OssService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamVenture Business Service</a> &gt; <a href="index.source.html" class="el_package">com.teamventure.app.service</a> &gt; <span class="el_source">OssService.java</span></div><h1>OssService.java</h1><pre class="source lang-java linenums">package com.teamventure.app.service;

import com.teamventure.app.support.BizException;
import com.teamventure.app.support.IdGenerator;
import io.minio.GetPresignedObjectUrlArgs;
import io.minio.MinioClient;
import io.minio.PutObjectArgs;
import io.minio.http.Method;
import java.io.InputStream;
import java.util.Locale;
import java.util.Objects;
import java.util.concurrent.TimeUnit;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

@Service
public class OssService {
<span class="nc" id="L21">    private static final Logger log = LoggerFactory.getLogger(OssService.class);</span>

<span class="nc" id="L23">    public enum Category {</span>
<span class="nc" id="L24">        AVATAR,</span>
<span class="nc" id="L25">        ITINERARY</span>
    }

<span class="nc" id="L28">    public record UploadResult(</span>
            Category category,
            String bucket,
            String objectKey,
            String url,
            boolean publicReadable
    ) {}

    private static final long MAX_IMAGE_BYTES = 10L * 1024 * 1024;

    private final MinioClient minio;
    private final MinioClient presignClient;
    private final String bucketAvatars;
    private final String bucketItinerary;
    private final String publicBaseUrl;
    private final int presignExpirySeconds;
    private final boolean avatarsPublic;

    public OssService(
            @Value(&quot;${TEAMVENTURE_OSS_ENDPOINT:http://minio:9000}&quot;) String endpoint,
            @Value(&quot;${TEAMVENTURE_OSS_PRESIGN_ENDPOINT:}&quot;) String presignEndpoint,
            @Value(&quot;${TEAMVENTURE_OSS_ACCESS_KEY:minioadmin}&quot;) String accessKey,
            @Value(&quot;${TEAMVENTURE_OSS_SECRET_KEY:minioadmin123456}&quot;) String secretKey,
            @Value(&quot;${MINIO_BUCKET_AVATARS:avatars}&quot;) String bucketAvatars,
            @Value(&quot;${MINIO_BUCKET_ITINERARY:itinerary}&quot;) String bucketItinerary,
            @Value(&quot;${MINIO_BUCKET_AVATARS_PUBLIC:0}&quot;) int avatarsPublic,
            @Value(&quot;${TEAMVENTURE_OSS_PUBLIC_BASE_URL:http://api.teamventure.com/oss}&quot;) String publicBaseUrl,
            @Value(&quot;${TEAMVENTURE_OSS_PRESIGN_EXPIRY_SECONDS:3600}&quot;) int presignExpirySeconds
<span class="nc" id="L56">    ) {</span>
<span class="nc" id="L57">        this.minio = MinioClient.builder().endpoint(endpoint).credentials(accessKey, secretKey).build();</span>
<span class="nc bnc" id="L58" title="All 4 branches missed.">        String p = (presignEndpoint == null || presignEndpoint.isBlank()) ? endpoint : presignEndpoint;</span>
<span class="nc" id="L59">        this.presignClient = MinioClient.builder().endpoint(p).credentials(accessKey, secretKey).build();</span>
<span class="nc" id="L60">        this.bucketAvatars = bucketAvatars;</span>
<span class="nc" id="L61">        this.bucketItinerary = bucketItinerary;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        this.publicBaseUrl = publicBaseUrl.endsWith(&quot;/&quot;) ? publicBaseUrl.substring(0, publicBaseUrl.length() - 1) : publicBaseUrl;</span>
<span class="nc" id="L63">        this.presignExpirySeconds = presignExpirySeconds;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        this.avatarsPublic = avatarsPublic == 1;</span>
<span class="nc" id="L65">    }</span>

    public UploadResult uploadImage(String userId, Category category, MultipartFile file, String scope) {
<span class="nc bnc" id="L68" title="All 4 branches missed.">        if (file == null || file.isEmpty()) {</span>
<span class="nc" id="L69">            throw new BizException(&quot;BAD_REQUEST&quot;, &quot;missing file&quot;);</span>
        }
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (file.getSize() &gt; MAX_IMAGE_BYTES) {</span>
<span class="nc" id="L72">            throw new BizException(&quot;BAD_REQUEST&quot;, &quot;file too large&quot;);</span>
        }
<span class="nc" id="L74">        String contentType = file.getContentType();</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">        if (contentType == null || !contentType.toLowerCase(Locale.ROOT).startsWith(&quot;image/&quot;)) {</span>
<span class="nc" id="L76">            throw new BizException(&quot;BAD_REQUEST&quot;, &quot;only image is allowed&quot;);</span>
        }

<span class="nc" id="L79">        String ext = guessExt(file.getOriginalFilename(), contentType);</span>
<span class="nc" id="L80">        String id = IdGenerator.newId(&quot;obj&quot;);</span>
<span class="nc" id="L81">        String bucket = bucketFor(category);</span>
<span class="nc" id="L82">        String objectKey = objectKeyFor(userId, category, scope, id, ext);</span>

<span class="nc" id="L84">        try (InputStream in = file.getInputStream()) {</span>
<span class="nc" id="L85">            minio.putObject(</span>
<span class="nc" id="L86">                    PutObjectArgs.builder()</span>
<span class="nc" id="L87">                            .bucket(bucket)</span>
<span class="nc" id="L88">                            .object(objectKey)</span>
<span class="nc" id="L89">                            .stream(in, file.getSize(), -1)</span>
<span class="nc" id="L90">                            .contentType(contentType)</span>
<span class="nc" id="L91">                            .build()</span>
            );
<span class="nc" id="L93">        } catch (Exception e) {</span>
<span class="nc" id="L94">            throw new BizException(&quot;OSS_UPLOAD_FAILED&quot;, &quot;upload failed&quot;);</span>
<span class="nc" id="L95">        }</span>

<span class="nc bnc" id="L97" title="All 6 branches missed.">        boolean isPublic = category == Category.ITINERARY || (category == Category.AVATAR &amp;&amp; avatarsPublic);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        String url = isPublic ? publicUrl(bucket, objectKey) : presignGet(bucket, objectKey);</span>
<span class="nc" id="L99">        return new UploadResult(category, bucket, objectKey, url, isPublic);</span>
    }

    public String presignGet(String bucket, String objectKey) {
        try {
<span class="nc" id="L104">            return presignClient.getPresignedObjectUrl(</span>
<span class="nc" id="L105">                    GetPresignedObjectUrlArgs.builder()</span>
<span class="nc" id="L106">                            .method(Method.GET)</span>
<span class="nc" id="L107">                            .bucket(bucket)</span>
<span class="nc" id="L108">                            .object(objectKey)</span>
<span class="nc" id="L109">                            .expiry(presignExpirySeconds, TimeUnit.SECONDS)</span>
<span class="nc" id="L110">                            .build()</span>
            );
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            log.warn(&quot;oss presign failed: bucket={}, key={}&quot;, bucket, objectKey, e);</span>
<span class="nc" id="L114">            throw new BizException(&quot;OSS_PRESIGN_FAILED&quot;, &quot;presign failed&quot;);</span>
        }
    }

    public String resolveAvatarUrl(String userId, String avatarUrl) {
<span class="nc bnc" id="L119" title="All 4 branches missed.">        if (avatarUrl == null || avatarUrl.isBlank()) return &quot;&quot;;</span>
<span class="nc" id="L120">        String normalized = avatarUrl.trim();</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">        if (normalized.startsWith(&quot;http://&quot;) || normalized.startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L122">            return normalized;</span>
        }
<span class="nc" id="L124">        String prefix = &quot;minio://avatars/&quot;;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!normalized.startsWith(prefix)) {</span>
<span class="nc" id="L126">            return &quot;&quot;;</span>
        }
<span class="nc" id="L128">        String key = normalized.substring(prefix.length());</span>
<span class="nc" id="L129">        String expectedPrefix = &quot;users/&quot; + userId + &quot;/&quot;;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (!key.startsWith(expectedPrefix)) {</span>
<span class="nc" id="L131">            return &quot;&quot;;</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        return avatarsPublic ? publicUrl(bucketAvatars, key) : presignGet(bucketAvatars, key);</span>
    }

    public String toAvatarStorageValue(String userId, String objectKey) {
<span class="nc" id="L137">        String expectedPrefix = &quot;users/&quot; + userId + &quot;/&quot;;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (!Objects.requireNonNull(objectKey).startsWith(expectedPrefix)) {</span>
<span class="nc" id="L139">            throw new BizException(&quot;BAD_REQUEST&quot;, &quot;invalid avatar key&quot;);</span>
        }
<span class="nc" id="L141">        return &quot;minio://avatars/&quot; + objectKey;</span>
    }

    private String bucketFor(Category category) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">        return switch (category) {</span>
<span class="nc" id="L146">            case AVATAR -&gt; bucketAvatars;</span>
<span class="nc" id="L147">            case ITINERARY -&gt; bucketItinerary;</span>
        };
    }

    private String objectKeyFor(String userId, Category category, String scope, String id, String ext) {
<span class="nc bnc" id="L152" title="All 4 branches missed.">        String safeExt = ext == null || ext.isBlank() ? &quot;bin&quot; : ext;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        return switch (category) {</span>
<span class="nc" id="L154">            case AVATAR -&gt; &quot;users/&quot; + userId + &quot;/avatars/&quot; + id + &quot;.&quot; + safeExt;</span>
            case ITINERARY -&gt; {
<span class="nc bnc" id="L156" title="All 4 branches missed.">                String safeScope = (scope == null || scope.isBlank()) ? &quot;general&quot; : sanitizePath(scope);</span>
<span class="nc" id="L157">                yield &quot;itinerary/&quot; + safeScope + &quot;/&quot; + id + &quot;.&quot; + safeExt;</span>
            }
        };
    }

    private String sanitizePath(String v) {
<span class="nc" id="L163">        String s = v.trim().replace(&quot;\\&quot;, &quot;/&quot;);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        while (s.startsWith(&quot;/&quot;)) s = s.substring(1);</span>
<span class="nc" id="L165">        s = s.replace(&quot;..&quot;, &quot;_&quot;);</span>
<span class="nc" id="L166">        return s.replaceAll(&quot;[^a-zA-Z0-9/_-]&quot;, &quot;_&quot;);</span>
    }

    private String publicUrl(String bucket, String objectKey) {
<span class="nc" id="L170">        return publicBaseUrl + &quot;/&quot; + bucket + &quot;/&quot; + objectKey;</span>
    }

    private String guessExt(String filename, String contentType) {
<span class="nc" id="L174">        String ext = null;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (filename != null) {</span>
<span class="nc" id="L176">            int i = filename.lastIndexOf('.');</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">            if (i &gt;= 0 &amp;&amp; i &lt; filename.length() - 1) {</span>
<span class="nc" id="L178">                ext = filename.substring(i + 1).toLowerCase(Locale.ROOT);</span>
            }
        }
<span class="nc bnc" id="L181" title="All 4 branches missed.">        if (ext == null || ext.isBlank()) {</span>
<span class="nc bnc" id="L182" title="All 5 branches missed.">            ext = switch (contentType.toLowerCase(Locale.ROOT)) {</span>
<span class="nc" id="L183">                case &quot;image/jpeg&quot; -&gt; &quot;jpg&quot;;</span>
<span class="nc" id="L184">                case &quot;image/png&quot; -&gt; &quot;png&quot;;</span>
<span class="nc" id="L185">                case &quot;image/webp&quot; -&gt; &quot;webp&quot;;</span>
<span class="nc" id="L186">                case &quot;image/gif&quot; -&gt; &quot;gif&quot;;</span>
<span class="nc" id="L187">                default -&gt; &quot;bin&quot;;</span>
            };
        }
<span class="nc" id="L190">        return ext;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>