<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StaticMapUrlCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamVenture Business Service</a> &gt; <a href="index.source.html" class="el_package">com.teamventure.infrastructure.cache</a> &gt; <span class="el_source">StaticMapUrlCache.java</span></div><h1>StaticMapUrlCache.java</h1><pre class="source lang-java linenums">package com.teamventure.infrastructure.cache;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import com.github.benmanes.caffeine.cache.stats.CacheStats;
import com.teamventure.domain.valueobject.MapRequest;
import com.teamventure.infrastructure.persistence.mapper.StaticMapUrlMapper;
import com.teamventure.infrastructure.persistence.po.StaticMapUrlPO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;
import java.util.function.Supplier;

/**
 * 静态地图URL三级缓存管理器
 *
 * 缓存架构：
 * - L1: Caffeine内存缓存（1000条，7天TTL，LRU淘汰）
 * - L2: Redis缓存（30天TTL）
 * - L3: MySQL数据库（永久存储，防缓存穿透）
 *
 * 查询顺序：L1 → L2 → L3 → 生成新URL
 * 回填策略：L3 → L2 → L1
 *
 * @author TeamVenture
 * @since 2026-01-14
 */
@Component
public class StaticMapUrlCache {

<span class="fc" id="L40">    private static final Logger log = LoggerFactory.getLogger(StaticMapUrlCache.class);</span>

    private final Cache&lt;String, String&gt; memoryCache;  // L1缓存
    private final RedisTemplate&lt;String, String&gt; redisTemplate;  // L2缓存
    private final StaticMapUrlMapper mapper;  // L3缓存

    @Value(&quot;${teamventure.map.cache.enabled:true}&quot;)
    private boolean cacheEnabled;

    @Value(&quot;${teamventure.map.cache.redis-ttl-days:30}&quot;)
    private int redisTtlDays;

    private static final String REDIS_KEY_PREFIX = &quot;map:static:&quot;;

    @Autowired
    public StaticMapUrlCache(
        @Value(&quot;${teamventure.map.cache.memory-size:1000}&quot;) int memorySize,
        @Value(&quot;${teamventure.map.cache.memory-ttl-days:7}&quot;) int memoryTtlDays,
        RedisTemplate&lt;String, String&gt; redisTemplate,
        StaticMapUrlMapper mapper
<span class="fc" id="L60">    ) {</span>
        // 初始化L1缓存（Caffeine）
<span class="fc" id="L62">        this.memoryCache = Caffeine.newBuilder()</span>
<span class="fc" id="L63">            .maximumSize(memorySize)</span>
<span class="fc" id="L64">            .expireAfterWrite(memoryTtlDays, TimeUnit.DAYS)</span>
<span class="fc" id="L65">            .recordStats()  // 记录缓存统计信息</span>
<span class="fc" id="L66">            .build();</span>

<span class="fc" id="L68">        this.redisTemplate = redisTemplate;</span>
<span class="fc" id="L69">        this.mapper = mapper;</span>

<span class="fc" id="L71">        log.info(&quot;StaticMapUrlCache initialized: L1 size={}, L1 TTL={}days, L2 TTL={}days&quot;,</span>
<span class="fc" id="L72">            memorySize, memoryTtlDays, redisTtlDays);</span>
<span class="fc" id="L73">    }</span>

    /**
     * 获取或生成静态地图URL
     *
     * @param request 地图请求参数
     * @param urlGenerator URL生成器（缓存未命中时调用）
     * @return 静态地图URL
     */
    public String getOrGenerate(MapRequest request, Supplier&lt;String&gt; urlGenerator) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (!cacheEnabled) {</span>
<span class="fc" id="L84">            return urlGenerator.get();</span>
        }

<span class="fc" id="L87">        String cacheKey = request.generateCacheKey();</span>

        // L1: 内存缓存
<span class="fc" id="L90">        String url = memoryCache.getIfPresent(cacheKey);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (url != null) {</span>
<span class="fc" id="L92">            log.debug(&quot;L1 cache hit: {}&quot;, cacheKey);</span>
<span class="fc" id="L93">            return url;</span>
        }

        // L2: Redis缓存
<span class="fc" id="L97">        url = getFromRedis(cacheKey);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (url != null) {</span>
<span class="fc" id="L99">            log.debug(&quot;L2 cache hit: {}&quot;, cacheKey);</span>
<span class="fc" id="L100">            memoryCache.put(cacheKey, url);  // 回填L1</span>
<span class="fc" id="L101">            return url;</span>
        }

        // L3: 数据库缓存
<span class="fc" id="L105">        url = getFromDatabase(cacheKey);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (url != null) {</span>
<span class="fc" id="L107">            log.debug(&quot;L3 cache hit: {}&quot;, cacheKey);</span>
<span class="fc" id="L108">            putToRedis(cacheKey, url);       // 回填L2</span>
<span class="fc" id="L109">            memoryCache.put(cacheKey, url);  // 回填L1</span>
<span class="fc" id="L110">            return url;</span>
        }

        // 缓存未命中：生成新URL
<span class="fc" id="L114">        log.info(&quot;Cache miss, generating new URL: {}&quot;, cacheKey);</span>
<span class="fc" id="L115">        url = urlGenerator.get();</span>

        // 写入所有缓存层
<span class="fc" id="L118">        saveToAllLayers(cacheKey, url, request);</span>

<span class="fc" id="L120">        return url;</span>
    }

    /**
     * 从Redis获取缓存
     */
    private String getFromRedis(String cacheKey) {
        try {
<span class="fc" id="L128">            return redisTemplate.opsForValue().get(REDIS_KEY_PREFIX + cacheKey);</span>
<span class="nc" id="L129">        } catch (Exception e) {</span>
<span class="nc" id="L130">            log.warn(&quot;Redis get failed: {}&quot;, e.getMessage());</span>
<span class="nc" id="L131">            return null;</span>
        }
    }

    /**
     * 写入Redis缓存
     */
    private void putToRedis(String cacheKey, String url) {
        try {
<span class="fc" id="L140">            redisTemplate.opsForValue().set(</span>
                REDIS_KEY_PREFIX + cacheKey,
                url,
                redisTtlDays,
                TimeUnit.DAYS
            );
<span class="nc" id="L146">        } catch (Exception e) {</span>
<span class="nc" id="L147">            log.warn(&quot;Redis put failed: {}&quot;, e.getMessage());</span>
<span class="fc" id="L148">        }</span>
<span class="fc" id="L149">    }</span>

    /**
     * 从数据库获取缓存
     */
    private String getFromDatabase(String cacheKey) {
        try {
<span class="fc" id="L156">            QueryWrapper&lt;StaticMapUrlPO&gt; query = new QueryWrapper&lt;&gt;();</span>
<span class="fc" id="L157">            query.eq(&quot;cache_key&quot;, cacheKey);</span>
<span class="fc" id="L158">            StaticMapUrlPO po = mapper.selectOne(query);</span>

<span class="fc bfc" id="L160" title="All 2 branches covered.">            if (po != null) {</span>
                // 异步更新命中次数
<span class="fc" id="L162">                CompletableFuture.runAsync(() -&gt; {</span>
                    try {
<span class="fc" id="L164">                        mapper.incrementHitCount(cacheKey);</span>
<span class="nc" id="L165">                    } catch (Exception e) {</span>
<span class="nc" id="L166">                        log.warn(&quot;Update hit count failed: {}&quot;, e.getMessage());</span>
<span class="fc" id="L167">                    }</span>
<span class="fc" id="L168">                });</span>
<span class="fc" id="L169">                return po.getUrl();</span>
            }
<span class="nc" id="L171">        } catch (Exception e) {</span>
<span class="nc" id="L172">            log.warn(&quot;Database get failed: {}&quot;, e.getMessage());</span>
<span class="fc" id="L173">        }</span>
<span class="fc" id="L174">        return null;</span>
    }

    /**
     * 保存到所有缓存层
     */
    private void saveToAllLayers(String cacheKey, String url, MapRequest request) {
        // L1: 内存缓存（同步）
<span class="fc" id="L182">        memoryCache.put(cacheKey, url);</span>

        // L2: Redis缓存（同步）
<span class="fc" id="L185">        putToRedis(cacheKey, url);</span>

        // L3: 数据库缓存（异步）
<span class="fc" id="L188">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L190">                StaticMapUrlPO po = new StaticMapUrlPO();</span>
<span class="fc" id="L191">                po.setCacheKey(cacheKey);</span>
<span class="fc" id="L192">                po.setUrl(url);</span>
<span class="fc" id="L193">                po.setRequest(serializeRequest(request));</span>
<span class="fc" id="L194">                po.setHitCount(0);</span>
<span class="fc" id="L195">                po.setCreatedAt(LocalDateTime.now());</span>

<span class="fc" id="L197">                mapper.insert(po);</span>
<span class="fc" id="L198">                log.debug(&quot;Saved to database: {}&quot;, cacheKey);</span>
<span class="nc" id="L199">            } catch (Exception e) {</span>
<span class="nc" id="L200">                log.error(&quot;Database save failed: {}&quot;, e.getMessage());</span>
<span class="fc" id="L201">            }</span>
<span class="fc" id="L202">        });</span>
<span class="fc" id="L203">    }</span>

    /**
     * 序列化请求参数为JSON（用于调试）
     */
    private String serializeRequest(MapRequest request) {
        try {
<span class="fc" id="L210">            return String.format(</span>
                &quot;{\&quot;size\&quot;:\&quot;%s\&quot;,\&quot;zoom\&quot;:%d,\&quot;center\&quot;:\&quot;%s\&quot;,\&quot;style\&quot;:\&quot;%s\&quot;}&quot;,
<span class="fc" id="L212">                request.getSize().name(),</span>
<span class="fc" id="L213">                request.getZoom(),</span>
<span class="fc" id="L214">                request.getCenter(),</span>
<span class="fc" id="L215">                request.getStyle()</span>
            );
<span class="nc" id="L217">        } catch (Exception e) {</span>
<span class="nc" id="L218">            return &quot;{}&quot;;</span>
        }
    }

    /**
     * 获取缓存统计信息（监控用）
     *
     * @return L1缓存统计
     */
    public CacheStats getStats() {
<span class="nc" id="L228">        return memoryCache.stats();</span>
    }

    /**
     * 清空L1内存缓存（仅用于测试）
     */
    public void clearMemoryCache() {
<span class="nc" id="L235">        memoryCache.invalidateAll();</span>
<span class="nc" id="L236">        log.warn(&quot;L1 memory cache cleared&quot;);</span>
<span class="nc" id="L237">    }</span>

    /**
     * 预热缓存（批量加载热门地图）
     *
     * @param requests 需要预热的请求列表
     * @param urlGenerator URL生成器
     */
    public void warmUp(List&lt;MapRequest&gt; requests, Supplier&lt;String&gt; urlGenerator) {
<span class="nc" id="L246">        log.info(&quot;Starting cache warm-up: {} requests&quot;, requests.size());</span>

<span class="nc" id="L248">        requests.forEach(request -&gt; {</span>
<span class="nc" id="L249">            String cacheKey = request.generateCacheKey();</span>
<span class="nc" id="L250">            String url = memoryCache.getIfPresent(cacheKey);</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (url == null) {</span>
                // 缓存未命中，生成并缓存
<span class="nc" id="L254">                url = urlGenerator.get();</span>
<span class="nc" id="L255">                memoryCache.put(cacheKey, url);</span>
<span class="nc" id="L256">                putToRedis(cacheKey, url);</span>
            }
<span class="nc" id="L258">        });</span>

<span class="nc" id="L260">        log.info(&quot;Cache warm-up completed&quot;);</span>
<span class="nc" id="L261">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>