# TeamVenture 前端集成测试完整指南

> **版本**: v1.2
> **更新日期**: 2026-01-04
> **测试范围**: 登录流程 + 方案生成流程
> **前置条件**: 后端服务已启动并通过健康检查

---

## 📋 目录

1. [环境准备](#环境准备)
2. [配置检查](#配置检查)
3. [登录流程测试](#登录流程测试)
4. [方案生成流程测试](#方案生成流程测试)
5. [我的方案列表测试](#我的方案列表测试)
6. [完整业务流程测试](#完整业务流程测试)
7. [常见问题排查](#常见问题排查)
8. [测试检查清单](#测试检查清单)

---

## 环境准备

### 1. 启动后端服务

```bash
cd /path/to/teamventure/src

# 确保所有服务运行
docker-compose up -d

# 验证服务状态
docker-compose ps

# 预期输出（所有服务 Up）:
# teamventure-nginx          Up
# teamventure-java           Up
# teamventure-mysql-master   Up (healthy)
# teamventure-redis          Up (healthy)
# teamventure-rabbitmq       Up (healthy)
# teamventure-python         Up

# 验证后端API可访问
curl http://localhost/actuator/health
# 应返回: {"status":"UP",...}
```

### 2. 打开微信开发者工具

1. **启动工具**: 打开微信开发者工具
2. **导入项目**:
   - 点击"导入项目"
   - 项目目录: `/path/to/teamventure/src/frontend/miniapp`
   - AppID: 使用测试号或真实AppID
   - 项目名称: TeamVenture

### 3. 配置开发者工具

**⚠️ 重要配置**（必须）：

1. 点击右上角"详情"按钮
2. 切换到"本地设置" tab
3. **必须勾选**以下选项：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书**
   - ✅ **不校验安全域名、TLS版本以及HTTPS证书**
   - ✅ **启用调试**
   - ✅ **ES6 转 ES5** (推荐)
   - ✅ **样式自动补全** (推荐)

4. 点击"确定"保存

**验证配置**:
- 打开"控制台"tab
- 检查是否有域名相关的错误
- 如果有，返回配置页面重新勾选

---

## 配置检查

### 1. 前端配置文件

**文件**: `src/frontend/miniapp/utils/config.js`

**检查项**:
```javascript
// 1. Mock模式已关闭
export const USE_MOCK_DATA = false  // 必须为 false

// 2. 环境为 local
const ENV = 'local'

// 3. API地址正确
const API_BASE_URLS = {
  local: 'http://localhost/api/v1',  // 指向本地Docker Nginx网关
  // ...
}

// 4. 登录端点正确
export const API_ENDPOINTS = {
  USER_LOGIN: '/auth/wechat/login',  // 注意：不是 /users/login
  PLAN_GENERATE: '/plans/generate',
  PLAN_LIST: '/plans',
  // ...
}
```

**如果配置不正确**:
1. 修改 `config.js` 文件
2. 保存后重新编译小程序（工具会自动编译）

### 2. 网络连通性测试

在开发者工具"控制台"中执行：

```javascript
// 测试网络连通性
wx.request({
  url: 'http://localhost/actuator/health',
  success: (res) => {
    console.log('后端连接成功:', res.data);
  },
  fail: (err) => {
    console.error('后端连接失败:', err);
  }
});
```

**预期结果**: 控制台输出 `后端连接成功: {status: "UP", ...}`

**如果连接失败**:
- 检查后端服务是否启动
- 检查"不校验合法域名"是否已勾选
- 检查URL是否正确（`http://localhost`，不是`https`）

---

## 登录流程测试

### 步骤 1: 进入登录页

1. **启动小程序**: 点击工具栏"编译"按钮
2. **导航到登录页**:
   - 方式1: 点击底部Tab "我的"
   - 方式2: 访问任何需要登录的页面会自动跳转

**预期界面**:
- 显示 TeamVenture Logo 或标题
- 显示"微信一键登录"按钮
- 界面简洁清晰

### 步骤 2: 点击"微信一键登录"

1. **点击按钮**: 点击"微信一键登录"
2. **观察控制台**: 打开"Console" tab观察日志

**预期行为**:
- 控制台输出: `[API] 调用 wx.login()`
- 控制台输出: `[API] 获取到 code: xxx`
- 页面显示用户信息表单（第二步）

**预期界面（第二步）**:
- 头像选择按钮（圆形，带相机图标）
- 昵称输入框
- "完成登录"按钮

### 步骤 3: 填写用户信息

1. **选择头像**:
   - 点击头像选择按钮
   - 从相册选择一张图片或拍照
   - 预期：头像预览显示选择的图片

2. **输入昵称**:
   - 在昵称输入框输入: "测试用户001"
   - 支持中文、英文、数字

3. **点击"完成登录"**

### 步骤 4: 验证登录成功

**观察网络请求** (Console → Network tab):
```
[API POST] http://localhost/api/v1/auth/wechat/login
请求体: {
  "code": "WECHAT_CODE",
  "nickname": "测试用户001",
  "avatarUrl": "https://thirdwx.qlogo.cn/..."
}

响应: {
  "success": true,
  "data": {
    "sessionToken": "eyJhbGc...",
    "userInfo": {
      "user_id": "user_xxx",
      "nickname": "测试用户001",
      "avatar": "https://...",
      "phone": null,
      "company": null,
      "role": "HR"
    }
  }
}
```

**验证本地存储** (Console → Storage → Storage tab):
```javascript
// 执行以下代码
wx.getStorageSync('sessionToken')
// 应返回 JWT token字符串

wx.getStorageSync('userInfo')
// 应返回用户信息对象 {user_id, nickname, avatar, ...}
```

**验证页面跳转**:
- 登录成功后自动跳转到首页
- 或保持在当前页，显示登录成功提示

### 步骤 5: 验证"我的"页面

1. **导航**: 点击底部Tab "我的"

**预期显示**:
- ✅ 用户头像正确显示（圆形）
- ✅ 用户昵称显示 "测试用户001"
- ✅ 显示统计数据卡片（总方案、收藏、已完成）
- ✅ 显示功能菜单
- ✅ 显示"退出登录"按钮

### 步骤 6: 测试退出登录

1. **点击"退出登录"**: 页面最下方
2. **确认退出**: 弹窗中点击"确定"

**预期行为**:
- 显示"已退出登录"提示
- 页面状态重置为未登录（显示"点击登录"按钮）
- 本地存储清空：
  ```javascript
  wx.getStorageSync('sessionToken')  // 返回空
  wx.getStorageSync('userInfo')       // 返回空
  ```

### ✅ 登录流程检查清单

- [ ] wx.login() 成功获取 code
- [ ] 头像选择器正常弹出并返回临时路径
- [ ] 昵称输入框支持输入
- [ ] 登录请求发送到正确的API
- [ ] 后端返回 sessionToken 和 userInfo
- [ ] sessionToken 存储到本地 storage
- [ ] userInfo 存储到本地 storage
- [ ] 登录成功后正确跳转
- [ ] "我的"页面正确显示用户信息
- [ ] 头像正确显示（不为空或占位符）
- [ ] 退出登录清除所有本地数据
- [ ] 退出后页面状态正确重置

---

## 方案生成流程测试

### 前置条件

- ✅ 已完成登录流程
- ✅ 当前有有效的session token

### 步骤 1: 进入生成方案页

1. **导航**: 点击底部Tab "生成方案"
2. **或**: 从首页点击"立即体验"按钮

**预期界面**:
- 显示两步表单流程指示器（第1步高亮）
- 显示基础信息表单

### 步骤 2: 填写基础信息（第1步）

**表单字段**:
1. **人数**: 输入 `50`
   - 验证：只能输入正整数
   - 范围：1-999

2. **预算**:
   - 最低预算: 输入 `10000`
   - 最高预算: 输入 `15000`
   - 验证：最高 >= 最低

3. **出发城市**: 输入 `北京`
   - 支持中文输入

4. **目的地**:
   - 方式1: 手动输入 `密云`
   - 方式2: 从首页点击热门目的地自动填充

5. **日期选择**:
   - 开始日期: 选择未来日期，如 `2026-02-01`
   - 结束日期: 选择未来日期，如 `2026-02-03`
   - 验证：结束日期 > 开始日期

**点击"下一步"**

**预期行为**:
- 前端验证通过
- 进入第2步（偏好选择）
- 流程指示器第2步高亮

### 步骤 3: 选择偏好（第2步）

**偏好选项**:

1. **活动类型** (多选):
   - 选择: ✅ 团队协作
   - 可选: 户外探险、文化体验、休闲娱乐

2. **住宿标准** (单选):
   - 选择: ⚪ 舒适型
   - 可选: 经济型、品质型

3. **餐饮偏好** (多选):
   - 选择: ✅ 农家菜
   - 可选: 烧烤、火锅、西餐

4. **特殊需求** (可选):
   - 输入: `需要会议室`

**点击"生成方案"**

### 步骤 4: 观察生成过程

**预期行为**:
- 显示 Loading 动画或进度指示器
- 显示提示文字: "AI正在为您生成方案，请稍候..."
- Loading 时间: 通常 30-60 秒

**观察网络请求** (Console → Network):
```
[API POST] http://localhost/api/v1/plans/generate
请求头: Authorization: Bearer {JWT_TOKEN}
请求体: {
  "people_count": 50,
  "budget_min": 10000,
  "budget_max": 15000,
  "start_date": "2026-02-01",
  "end_date": "2026-02-03",
  "departure_city": "北京",
  "preferences": {
    "activity_types": ["team_building"],
    "accommodation": "standard",
    "dining": ["local"],
    "special_requests": "需要会议室"
  }
}

响应: {
  "success": true,
  "data": {
    "plan_request_id": "plan_req_xxx",
    "status": "generating"
  }
}
```

### 步骤 5: 验证生成结果

**场景 A: AI生成成功（理想情况）**

**预期行为**:
- Loading 结束
- 跳转到"对比页"
- 显示 3 套方案卡片：
  - 💰 经济型
  - ⚖️ 平衡型
  - ✨ 品质型

**每个方案卡片显示**:
- 方案名称
- 总预算（元）
- 人均预算（元/人）
- 天数（X天Y夜）
- 3-5个亮点标签
- "查看详情"按钮

**场景 B: AI生成中（等待状态）**

由于AI生成需要时间（通过RabbitMQ异步处理），可能需要：
- 方式1: 轮询查询方案状态
- 方式2: 显示"生成中，请稍候"并提供刷新按钮
- 方式3: 跳转到"我的方案"查看生成进度

**场景 C: 生成超时或失败**

**预期行为**:
- 显示友好错误提示: "方案生成失败，请稍后重试"
- 提供"重新生成"按钮
- 输入数据不丢失（可重新提交）

### 步骤 6: 查看方案详情

1. **点击任意方案的"查看详情"**

**预期界面**:
- 方案标题和类型
- 行程安排（按天展示）
  - 每天的活动列表
  - 时间、地点、描述
- 预算明细
  - 住宿费用
  - 餐饮费用
  - 活动费用
  - 交通费用
  - 总计
- 供应商信息
  - 供应商名称
  - 联系方式（电话、微信）
  - 地址
  - 评分
- "确认此方案"按钮
- "返回对比"按钮

### 步骤 7: 确认方案

1. **点击"确认此方案"**

**预期行为**:
- 显示确认弹窗: "确定选择此方案吗？"
- 点击"确定"
- 发送API请求

**观察网络请求**:
```
[API POST] http://localhost/api/v1/plans/{plan_id}/confirm
请求头: Authorization: Bearer {JWT_TOKEN}

响应: {
  "success": true
}
```

**验证状态更新**:
- 方案状态从 "draft" 变为 "confirmed"
- 按钮文字变为 "已确认"（禁用状态）
- 显示成功提示

### 步骤 8: 联系供应商

1. **在详情页找到供应商信息**
2. **点击"拨打电话"按钮**

**预期行为**:
- 调起系统拨号界面
- 显示供应商电话号码
- 用户可选择拨打或取消

**或点击"复制微信"**:
- 微信号复制到剪贴板
- 显示"已复制"提示

**后端记录验证**:
```
[API POST] http://localhost/api/v1/plans/{plan_id}/supplier-contacts
请求体: {
  "supplier_id": "sup_xxx",
  "channel": "PHONE",  // 或 "WECHAT"
  "notes": ""
}

响应: {
  "success": true
}
```

### ✅ 方案生成流程检查清单

- [ ] 基础信息表单验证正常
- [ ] 所有字段都能正确输入
- [ ] "下一步"按钮正常跳转
- [ ] 偏好选择界面显示正常
- [ ] "生成方案"按钮发送正确请求
- [ ] Loading 状态正常显示
- [ ] 请求携带正确的 Authorization header
- [ ] 对比页正确显示（或等待状态）
- [ ] 方案卡片信息完整
- [ ] 详情页行程显示正常
- [ ] 预算明细正确展示
- [ ] 供应商信息完整
- [ ] "确认方案"功能正常
- [ ] 状态更新正确
- [ ] 联系供应商功能正常
- [ ] 后端记录联系日志

---

## 我的方案列表测试

### 步骤 1: 进入我的方案页

1. **导航**: 点击底部Tab "我的方案"

**预期界面**:
- 显示方案列表
- 每个方案卡片显示：
  - 方案标题
  - 目的地
  - 日期
  - 总预算
  - 人数
  - 状态标签（生成中/草稿/已确认）

### 步骤 2: 测试下拉刷新

1. **下拉列表**: 在列表顶部向下拉动
2. **松开触发刷新**

**预期行为**:
- 显示刷新动画
- 重新请求API
- 列表数据更新
- 刷新动画消失

### 步骤 3: 测试上拉加载更多

（如果方案数 > 10条）

1. **滚动到列表底部**

**预期行为**:
- 显示"加载中..."
- 自动请求下一页
- 新数据追加到列表
- 如果没有更多数据，显示"没有更多了"

### 步骤 4: 测试左滑删除

1. **在方案卡片上向左滑动**
2. **显示"删除"按钮**
3. **点击"删除"**

**预期行为**:
- 弹出确认对话框: "确定删除此方案吗？"
- 点击"确定"
- 发送删除请求（如有API）
- 方案从列表移除
- 列表重新渲染

### 步骤 5: 点击方案卡片

1. **点击任意方案**

**预期行为**:
- 跳转到详情页
- 显示完整方案信息
- 与之前查看的内容一致

### ✅ 我的方案列表检查清单

- [ ] 列表正确显示当前用户的方案
- [ ] 不显示其他用户的方案
- [ ] 卡片信息完整准确
- [ ] 状态标签正确（生成中/草稿/已确认）
- [ ] 下拉刷新功能正常
- [ ] 上拉加载更多功能正常
- [ ] 左滑删除功能正常
- [ ] 删除确认弹窗正常
- [ ] 删除后列表更新
- [ ] 点击卡片跳转详情
- [ ] 空列表显示友好提示

---

## 完整业务流程测试

### 端到端流程（Happy Path）

**完整路径**: 登录 → 生成方案 → 对比选择 → 确认 → 联系供应商 → 查看我的方案

1. **新用户注册登录**
   - 点击"微信一键登录"
   - 选择头像，输入昵称
   - 完成登录

2. **从首页进入**
   - 查看首页Banner
   - 点击热门目的地"密云"（自动预填）
   - 或点击"立即体验"

3. **生成方案**
   - 填写基础信息（人数50，预算10000-15000）
   - 选择偏好（团队协作，舒适型，农家菜）
   - 点击"生成方案"
   - 等待AI生成（30-60秒）

4. **对比方案**
   - 查看3套方案
   - 对比价格、亮点
   - 点击"查看详情"

5. **查看详情**
   - 浏览行程安排
   - 查看预算明细
   - 查看供应商信息

6. **确认方案**
   - 点击"确认此方案"
   - 确认弹窗点击"确定"
   - 状态变为"已确认"

7. **联系供应商**
   - 点击"拨打电话"或"复制微信"
   - 系统调起拨号或复制成功

8. **查看我的方案**
   - 切换到"我的方案"Tab
   - 查看刚才确认的方案
   - 状态显示"已确认"

9. **退出登录**
   - 切换到"我的"Tab
   - 点击"退出登录"
   - 确认退出

### 异常场景测试

**场景 1: 网络断开**
- 断开网络连接
- 尝试生成方案
- 预期：显示"网络错误"提示

**场景 2: Token过期**
- 等待Token过期（24小时）或手动清除token
- 尝试访问需要登录的页面
- 预期：自动跳转登录页

**场景 3: 参数验证**
- 预算最低 > 最高
- 预期：前端就地提示错误

**场景 4: 生成超时**
- 模拟AI生成超时
- 预期：显示超时提示，可重试

---

## 常见问题排查

### 问题 1: 登录按钮无响应

**可能原因**:
- wx.login() 调用失败
- Mock模式未关闭

**排查步骤**:
1. 打开Console查看错误日志
2. 检查 `config.js` 中 `USE_MOCK_DATA` 是否为 `false`
3. 检查微信开发者工具版本（需 ≥ 1.06）

### 问题 2: 头像选择无反应

**可能原因**:
- open-type="chooseAvatar" 不支持（微信版本 < 8.0.16）
- 权限未授予

**解决方法**:
- 更新微信开发者工具到最新版本
- 检查button组件的open-type属性

### 问题 3: API请求失败 (fail)

**可能原因**:
- 后端服务未启动
- URL配置错误
- 未勾选"不校验合法域名"

**排查步骤**:
1. 检查后端服务: `curl http://localhost/actuator/health`
2. 检查config.js中的API_BASE_URL
3. 检查微信开发者工具"本地设置"

### 问题 4: API返回 401 Unauthorized

**可能原因**:
- Token未正确存储
- Token已过期
- Authorization header格式错误

**排查步骤**:
```javascript
// 在Console中检查
wx.getStorageSync('sessionToken')
// 应返回一个JWT token字符串，格式: eyJhbGc...
```

### 问题 5: 方案生成一直Loading

**可能原因**:
- Python AI服务未启动
- RabbitMQ未运行
- 数据库连接失败

**排查步骤**:
```bash
# 检查Python服务
docker logs teamventure-python

# 检查RabbitMQ
docker logs teamventure-rabbitmq

# 检查队列消息
# 访问 http://localhost:15672 (admin/admin123456)
```

### 问题 6: 页面样式错乱

**可能原因**:
- WXSS文件未正确加载
- rpx单位计算问题

**解决方法**:
- 重新编译小程序
- 检查Console中的样式错误
- 清除缓存后重试

---

## 测试检查清单

### 总体检查（必须全部通过）

#### 环境配置
- [ ] 后端所有服务正常运行
- [ ] 健康检查返回UP
- [ ] 微信开发者工具正确配置
- [ ] 前端config.js配置正确
- [ ] Mock模式已关闭

#### 登录功能
- [ ] wx.login()成功
- [ ] 头像选择正常
- [ ] 昵称输入正常
- [ ] API请求成功
- [ ] Token存储成功
- [ ] 用户信息存储成功
- [ ] 页面跳转正确
- [ ] "我的"页面显示正确
- [ ] 退出登录功能正常

#### 方案生成功能
- [ ] 基础信息表单正常
- [ ] 偏好选择正常
- [ ] 生成请求成功
- [ ] Loading状态正常
- [ ] 对比页显示正常（或等待）
- [ ] 详情页完整
- [ ] 确认功能正常
- [ ] 供应商联系功能正常

#### 我的方案功能
- [ ] 列表显示正常
- [ ] 下拉刷新正常
- [ ] 上拉加载正常
- [ ] 左滑删除正常
- [ ] 详情查看正常

#### 异常处理
- [ ] 网络错误提示友好
- [ ] Token过期自动处理
- [ ] 参数验证正确
- [ ] 超时处理正常

---

## 测试数据建议

### 测试用例数据集

**用户1**: 小型团建
- 人数: 20
- 预算: 5000-8000
- 目的地: 密云
- 日期: 1天（当天往返）

**用户2**: 中型团建
- 人数: 50
- 预算: 10000-15000
- 目的地: 怀柔
- 日期: 2天1夜

**用户3**: 大型团建
- 人数: 100
- 预算: 30000-50000
- 目的地: 延庆
- 日期: 3天2夜

---

## 下一步

完成前端集成测试后：

1. **记录问题**: 将发现的bug记录到 `docs/qa/buglist.md`
2. **性能测试**: 使用真机测试性能和流畅度
3. **兼容性测试**: 测试不同手机型号和微信版本
4. **用户验收**: 邀请真实用户进行UAT测试

---

**文档维护**: 请在每次功能更新后同步更新本文档
**反馈渠道**: 发现问题请提交到项目Issue
