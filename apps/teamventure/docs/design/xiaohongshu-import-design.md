# 小红书内容导入功能设计文档

## 1. 功能概述

### 1.1 用户痛点
当前"生成方案"页面采用纯Markdown编辑方式，用户需要手动填写所有行程信息，操作繁琐且门槛较高。

### 1.2 解决方案
支持用户粘贴小红书旅行攻略链接，系统自动解析页面内容，AI提取结构化行程信息，一键生成团建方案。

### 1.3 核心流程
```
用户粘贴小红书链接 → 后端抓取页面内容 → AI解析提取行程 → 填充到Markdown模板 → 用户微调后生成方案
```

---

## 2. 交互设计

### 2.1 入口位置
在现有"生成方案"页面的 `template-actions` 区域新增"小红书导入"按钮，与"AI填充"、"重置"按钮并列。

```
┌─────────────────────────────────────────────────────────┐
│  ✏️ 直接修改示例内容为您的实际需求                        │
├─────────────────────────────────────────────────────────┤
│  [📱 小红书导入]  [✨ AI填充]  [🔄 重置]                  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 导入弹窗设计

#### 弹窗结构
```
┌─────────────────────────────────────────┐
│  📱 导入小红书攻略              ✕       │
├─────────────────────────────────────────┤
│                                         │
│  💡 支持导入小红书旅行/团建攻略，       │
│     AI将自动提取行程信息                │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 粘贴小红书链接或分享口令...      │   │
│  │                                 │   │
│  │                         [粘贴]  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  📋 支持的链接格式：                    │
│  • https://www.xiaohongshu.com/...     │
│  • xhslink.com/...                     │
│  • 分享口令（如：7 kitwe 小红书...）    │
│                                         │
├─────────────────────────────────────────┤
│       [取消]          [开始解析]        │
└─────────────────────────────────────────┘
```

#### 解析中状态
```
┌─────────────────────────────────────────┐
│  📱 导入小红书攻略              ✕       │
├─────────────────────────────────────────┤
│                                         │
│          ⚡ 正在解析中...               │
│                                         │
│          ████████░░░░░░░ 60%            │
│                                         │
│     正在提取行程信息，请稍候...         │
│                                         │
└─────────────────────────────────────────┘
```

#### 解析成功预览
```
┌─────────────────────────────────────────┐
│  📱 导入小红书攻略              ✕       │
├─────────────────────────────────────────┤
│                                         │
│  ✅ 解析成功！已识别以下行程信息：      │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 📍 目的地：三亚                  │   │
│  │ 📅 天数：5天4夜                  │   │
│  │ 💰 预算：约¥3000/人              │   │
│  │ 🏨 住宿：亚特兰蒂斯酒店          │   │
│  │ 🎯 景点：蜈支洲岛、天涯海角...   │   │
│  └─────────────────────────────────┘   │
│                                         │
│  💡 点击确认后将填充到方案模板中，      │
│     您可以继续编辑调整                  │
│                                         │
├─────────────────────────────────────────┤
│       [重新输入]       [确认导入]       │
└─────────────────────────────────────────┘
```

#### 解析失败状态
```
┌─────────────────────────────────────────┐
│  📱 导入小红书攻略              ✕       │
├─────────────────────────────────────────┤
│                                         │
│  ❌ 解析失败                            │
│                                         │
│  无法获取页面内容，可能原因：           │
│  • 链接格式不正确                       │
│  • 该笔记已被删除或设为私密             │
│  • 网络连接异常                         │
│                                         │
│  请检查链接后重试                       │
│                                         │
├─────────────────────────────────────────┤
│       [取消]          [重新输入]        │
└─────────────────────────────────────────┘
```

### 2.3 状态机设计

```
                    ┌──────────────┐
                    │    idle      │ 初始状态
                    └──────┬───────┘
                           │ 点击"开始解析"
                           ▼
                    ┌──────────────┐
         ┌─────────│   parsing    │ 解析中
         │         └──────┬───────┘
         │                │
    失败 │       ┌────────┴────────┐ 成功
         │       ▼                 ▼
         │ ┌──────────┐     ┌───────────┐
         └►│  error   │     │  preview  │ 预览
           └────┬─────┘     └─────┬─────┘
                │                 │ 点击"确认导入"
                │ 点击"重新输入"   ▼
                │           ┌───────────┐
                └──────────►│   idle    │ 返回初始
                            └───────────┘
```

---

## 3. 数据结构设计

### 3.1 前端状态
```javascript
// index.js 新增 data 字段
data: {
  // 小红书导入相关
  showXhsImportDialog: false,        // 是否显示导入弹窗
  xhsImportStatus: 'idle',           // idle | parsing | preview | error
  xhsLink: '',                       // 用户输入的链接
  xhsParseProgress: 0,               // 解析进度 0-100
  xhsParseResult: null,              // 解析结果
  xhsParseError: '',                 // 错误信息
}
```

### 3.2 解析结果数据结构
```javascript
// xhsParseResult 结构
{
  success: true,
  data: {
    title: "三亚5天4夜超详细攻略",      // 原文标题
    destination: "三亚",               // 目的地
    days: 5,                          // 天数
    budget: "3000",                   // 预算（每人）
    budgetUnit: "元/人",
    highlights: [                      // 亮点/景点
      "蜈支洲岛",
      "天涯海角",
      "亚特兰蒂斯水世界"
    ],
    accommodation: "亚特兰蒂斯酒店",    // 住宿
    itinerary: [                       // 按天行程
      {
        day: 1,
        activities: ["接机", "酒店入住", "海边散步"]
      },
      {
        day: 2,
        activities: ["蜈支洲岛一日游"]
      }
      // ...
    ],
    tips: [                           // 注意事项
      "防晒必备",
      "提前预约景点"
    ],
    sourceUrl: "https://...",         // 原文链接
    sourceTitle: "原文标题",
    sourceAuthor: "作者昵称"
  }
}
```

### 3.3 API 接口设计

#### 请求
```
POST /api/v1/import/xiaohongshu/parse

Request Body:
{
  "link": "https://www.xiaohongshu.com/explore/xxx"
  // 或 "xhslink.com/xxx"
  // 或 "7 kitwe 小红书分享口令..."
}

Headers:
  Authorization: Bearer <token>
  Content-Type: application/json
```

#### 响应
```json
{
  "success": true,
  "data": {
    "title": "三亚5天4夜超详细攻略",
    "destination": "三亚",
    "days": 5,
    "budget": "3000",
    "highlights": ["蜈支洲岛", "天涯海角"],
    "accommodation": "亚特兰蒂斯酒店",
    "itinerary": [...],
    "tips": [...],
    "rawContent": "原始文本内容（供调试）",
    "generatedMarkdown": "# 团建行程方案\n\n## 基本信息\n..."
  },
  "message": "解析成功"
}
```

#### 错误响应
```json
{
  "success": false,
  "error": {
    "code": "PARSE_FAILED",
    "message": "无法获取页面内容，请检查链接是否正确"
  }
}
```

---

## 4. 技术实现方案

### 4.1 前端实现（微信小程序）
- 在 `pages/index/index.wxml` 新增导入按钮和弹窗组件
- 在 `pages/index/index.js` 新增相关处理方法
- 在 `pages/index/index.wxss` 新增相关样式
- 复用现有的 AI 填充弹窗样式模式

### 4.2 后端实现（Python AI Service）
- 新增 `/api/v1/import/xiaohongshu/parse` 接口
- 实现小红书页面内容抓取（处理反爬）
- 实现 AI 内容解析（提取结构化信息）
- 生成 Markdown 模板内容

### 4.3 技术难点与解决方案

| 难点 | 解决方案 |
|------|----------|
| 小红书反爬机制 | 使用 Playwright 无头浏览器模拟真实访问 |
| 分享口令解析 | 正则提取口令中的链接标识，拼接完整URL |
| 内容结构多样 | AI 大模型提取，支持多种格式输入 |
| 解析耗时较长 | 前端轮询进度 + 后端异步处理 |

---

## 5. 实现计划

### Phase 8 任务拆分

| 序号 | 任务 | 预估时间 |
|------|------|----------|
| 1 | ✅ 设计交互流程和UI（本文档） | 30分钟 |
| 2 | 前端：新增导入按钮和弹窗组件 | 1小时 |
| 3 | 后端：实现网页内容抓取服务 | 2小时 |
| 4 | 后端：实现AI解析内容为结构化行程 | 1.5小时 |
| 5 | 前端：集成导入功能到方案生成流程 | 1小时 |
| 6 | 端到端测试 | 30分钟 |

---

## 6. 附录

### 6.1 小红书链接格式示例
```
# 标准链接
https://www.xiaohongshu.com/explore/6789abcd1234567890abcdef

# 短链接
https://xhslink.com/abc123

# 分享口令
7 kitwe 小红书分享：三亚超全攻略！http://xhslink.com/xxx

# 移动端分享链接
https://www.xiaohongshu.com/discovery/item/6789abcd1234567890abcdef
```

### 6.2 UI 配色方案
- 主色调：沿用现有 `#1890ff`（蓝色）
- 小红书品牌色：`#FE2C55`（红色，用于图标点缀）
- 成功状态：`#52c41a`（绿色）
- 错误状态：`#ff4d4f`（红色）
- 进度条：渐变 `#667eea → #764ba2`

---

*文档版本: v1.0*
*创建时间: 2026-01-18*
*作者: Claude Code*
